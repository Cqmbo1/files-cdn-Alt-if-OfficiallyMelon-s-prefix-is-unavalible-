"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[7],{2542:(p,h,r)=>{r.d(h,{d:()=>P});var m=r(1136),L=r(1140),z=r(1109),C=r(1417),v=r(1424),O=r(1152),T=r(1373),x=r(1250),s=r(1238);x.b.prototype.setDepthStencilTexture=function(p,h){this._engine.setDepthStencilTexture(this._samplers[p],this._uniforms[p],h,p)};class P extends z.e{get renderList(){return this._renderList}set renderList(p){this._renderList!==p&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),p&&(this._unObserveRenderList=(0,O.g)(p,this._renderListHasChanged)),this._renderList=p)}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(p){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(p)}set onBeforeRender(p){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(p)}set onAfterRender(p){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(p)}set onClear(p){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(p)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(p,h){let r;r=Array.isArray(p)?p:[p];for(let p=0;p<r.length;++p)for(let m=0;m<this._renderPassIds.length;++m)r[p].setMaterialForRenderPass(this._renderPassIds[m],void 0!==h?Array.isArray(h)?h[m]:h:void 0)}get isMulti(){var p;return(null===(p=this._renderTarget)||void 0===p?void 0:p.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(p){if(this._boundingBoxSize&&this._boundingBoxSize.equals(p))return;this._boundingBoxSize=p;const h=this.getScene();h&&h.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var p;return(null===(p=this._renderTarget)||void 0===p?void 0:p._depthStencilTexture)??null}constructor(p,h,r){let C,O=arguments.length>3&&void 0!==arguments[3]&&arguments[3],T=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],x=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6],P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:z.e.TRILINEAR_SAMPLINGMODE,G=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],k=arguments.length>9&&void 0!==arguments[9]&&arguments[9],M=arguments.length>10&&void 0!==arguments[10]&&arguments[10],H=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,I=arguments.length>12&&void 0!==arguments[12]&&arguments[12],U=arguments.length>13?arguments[13]:void 0,E=arguments.length>14?arguments[14]:void 0,j=arguments.length>15&&void 0!==arguments[15]&&arguments[15],c=arguments.length>16&&void 0!==arguments[16]&&arguments[16],W=!0;if("object"===typeof O){const p=O;O=!!p.generateMipMaps,T=p.doNotChangeAspectRatio??!0,x=p.type??0,s=!!p.isCube,P=p.samplingMode??z.e.TRILINEAR_SAMPLINGMODE,G=p.generateDepthBuffer??!0,k=!!p.generateStencilBuffer,M=!!p.isMulti,H=p.format??5,I=!!p.delayAllocation,U=p.samples,E=p.creationFlags,j=!!p.noColorAttachment,c=!!p.useSRGBBuffer,C=p.colorAttachment,W=p.gammaSpace??W}if(super(null,r,!O,void 0,P,void 0,void 0,void 0,void 0,H),this._unObserveRenderList=null,this._renderListHasChanged=(p,h)=>{const r=this._renderList?this._renderList.length:0;var m;(0===h&&r>0||0===r)&&(null===(m=this.getScene())||void 0===m||m.meshes.forEach((p=>{p._markSubMeshesAsLightDirty()})))},this.particleSystemList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new m.c,this.onAfterUnbindObservable=new m.c,this.onBeforeRenderObservable=new m.c,this.onAfterRenderObservable=new m.c,this.onClearObservable=new m.c,this.onResizeObservable=new m.c,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=L.m.Zero(),this._dumpToolsLoading=!1,!(r=this.getScene()))return;const K=this.getScene().getEngine();this._gammaSpace=W,this._coordinatesMode=z.e.PROJECTION_MODE,this.renderList=[],this.name=p,this.isRenderTarget=!0,this._initialSizeParameter=h,this._renderPassIds=[],this._isCubeData=s,this._processSizeParameter(h),this.renderPassId=this._renderPassIds[0],this._resizeObserver=K.onResizeObservable.add((()=>{})),this._generateMipMaps=!!O,this._doNotChangeAspectRatio=T,this._renderingManager=new v.e(r),this._renderingManager._useSceneAutoClearSetup=!0,M||(this._renderTargetOptions={generateMipMaps:O,type:x,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:G,generateStencilBuffer:k,samples:U,creationFlags:E,noColorAttachment:j,useSRGBBuffer:c,colorAttachment:C,label:this.name},this.samplingMode===z.e.NEAREST_SAMPLINGMODE&&(this.wrapU=z.e.CLAMP_ADDRESSMODE,this.wrapV=z.e.CLAMP_ADDRESSMODE),I||(s?(this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=z.e.INVCUBIC_MODE,this._textureMatrix=L.b.Identity()):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==U&&(this.samples=U)))}createDepthStencilTexture(){var p;let h=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],m=arguments.length>2&&void 0!==arguments[2]&&arguments[2],L=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,z=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,C=arguments.length>5?arguments[5]:void 0;null===(p=this._renderTarget)||void 0===p||p.createDepthStencilTexture(h,r,m,L,z,C)}_releaseRenderPassId(){if(this._scene){const p=this._scene.getEngine();for(let h=0;h<this._renderPassIds.length;++h)p.releaseRenderPassId(this._renderPassIds[h])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const p=this._scene.getEngine(),h=this._isCubeData?6:this.getRenderLayers()||1;for(let r=0;r<h;++r)this._renderPassIds[r]=p.createRenderPassId(`RenderTargetTexture - ${this.name}#${r}`)}_processSizeParameter(p){let h=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(p.ratio){this._sizeRatio=p.ratio;const h=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(h.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(h.getRenderHeight(),this._sizeRatio)}}else this._size=p;h&&this._createRenderPassId()}get samples(){var p;return(null===(p=this._renderTarget)||void 0===p?void 0:p.samples)??this._samples}set samples(p){this._renderTarget&&(this._samples=this._renderTarget.setSamples(p))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(p){this._refreshRate=p,this.resetRefreshCounter()}addPostProcess(p){if(!this._postProcessManager){const p=this.getScene();if(!p)return;this._postProcessManager=new C.d(p),this._postProcesses=new Array}this._postProcesses.push(p),this._postProcesses[0].autoClear=!1}clearPostProcesses(){let p=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(p)for(const p of this._postProcesses)p.dispose();this._postProcesses=[]}}removePostProcess(p){if(!this._postProcesses)return;const h=this._postProcesses.indexOf(p);-1!==h&&(this._postProcesses.splice(h,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const p=this._size.layers;if(p)return p;const h=this._size.depth;return h||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(p){const h=Math.max(1,this.getRenderSize()*p);this.resize(h)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(p){var h;const r=this.isCube;null===(h=this._renderTarget)||void 0===h||h.dispose(),this._renderTarget=null;const m=this.getScene();m&&(this._processSizeParameter(p,!1),this._renderTarget=r?m.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):m.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let p=arguments.length>0&&void 0!==arguments[0]&&arguments[0],h=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(p,h)}isReadyForRendering(){return this._dumpToolsLoading||(this._dumpToolsLoading=!0,r.e(10).then(r.bind(r,2746)).then((p=>this._dumpTools=p))),this._render(!1,!1,!0)}_render(){let p=arguments.length>0&&void 0!==arguments[0]&&arguments[0],h=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const m=this.getScene();if(!m)return r;const L=m.getEngine();if(void 0!==this.useCameraPostProcesses&&(p=this.useCameraPostProcesses),this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let p=0;p<this._waitingRenderList.length;p++){const h=this._waitingRenderList[p],r=m.getMeshById(h);r&&this.renderList.push(r)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const p=this.getScene();if(!p)return r;const h=p.meshes;for(let p=0;p<h.length;p++){const r=h[p];this.renderListPredicate(r)&&this.renderList.push(r)}}const z=L.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const C=this.activeCamera??m.activeCamera,v=m.activeCamera;C&&(C!==m.activeCamera&&(m.setTransformMatrix(C.getViewMatrix(),C.getProjectionMatrix(!0)),m.activeCamera=C),L.setViewport(C.rigParent?C.rigParent.viewport:C.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let O=r;if(r){m.getViewMatrix()||m.updateTransformMatrix();const p=this.is2DArray||this.is3D?this.getRenderLayers():this.isCube?6:1;for(let h=0;h<p&&O;h++){let p=null;const z=this.renderList?this.renderList:m.getActiveMeshes().data,C=this.renderList?this.renderList.length:m.getActiveMeshes().length;L.currentRenderPassId=this._renderPassIds[h],this.onBeforeRenderObservable.notifyObservers(h),this.getCustomRenderList&&(p=this.getCustomRenderList(h,z,C)),p||(p=z),this._doNotChangeAspectRatio||m.updateTransformMatrix(!0);for(let h=0;h<p.length&&O;++h){const m=p[h];if(m.isEnabled()&&!m.isBlocked&&m.isVisible&&m.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(m,this.refreshRate,r)){O=!1;continue}}else if(!m.isReady(!0)){O=!1;continue}}this.onAfterRenderObservable.notifyObservers(h),(this.is2DArray||this.is3D||this.isCube)&&(m.incrementRenderId(),m.resetCachedMaterial())}const h=this.particleSystemList||m.particleSystems;for(const p of h)p.isReady()||(O=!1)}else if(!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,p,h,void 0,C),m.incrementRenderId(),m.resetCachedMaterial();else this._renderToTarget(0,p,h,void 0,C);else for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,p,h,r,C),m.incrementRenderId(),m.resetCachedMaterial();return this.onAfterUnbindObservable.notifyObservers(this),L.currentRenderPassId=z,m.activeCamera=v,v&&(this.activeCamera&&this.activeCamera!==m.activeCamera&&m.setTransformMatrix(v.getViewMatrix(),v.getProjectionMatrix(!0)),L.setViewport(v.viewport)),m.resetCachedMaterial(),O}_bestReflectionRenderTargetDimension(p,h){const r=p*h,m=(0,T.i)(r+16384/(128+r));return Math.min((0,T.d)(p),m)}_prepareRenderingManager(p,h,r,m){const L=this.getScene();if(!L)return;this._renderingManager.reset();const z=L.getRenderId();for(let C=0;C<h;C++){const h=p[C];if(h&&!h.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(h,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!h.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!h._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r&&(h._internalAbstractMeshDataInfo._currentLOD=L.customLODSelector?L.customLODSelector(h,r):h.getLOD(r),h._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!h._internalAbstractMeshDataInfo._currentLOD)continue;let p,C=h._internalAbstractMeshDataInfo._currentLOD;if(C!==h&&0!==C.billboardMode&&C.computeWorldMatrix(),C._preActivateForIntermediateRendering(z),p=!(!m||!r)&&0===(h.layerMask&r.layerMask),h.isEnabled()&&h.isVisible&&h.subMeshes&&!p){if(C!==h&&C._activate(z,!0),h._activate(z,!0)&&h.subMeshes.length){h.isAnInstance?h._internalAbstractMeshDataInfo._actAsRegularMesh&&(C=h):C._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,C._internalAbstractMeshDataInfo._isActiveIntermediate=!0,L._prepareSkeleton(C);for(let p=0;p<C.subMeshes.length;p++){const h=C.subMeshes[p];this._renderingManager.dispatch(h,C)}}h._postActivate()}}}const C=this.particleSystemList||L.particleSystems;for(let p=0;p<C.length;p++){const h=C[p],r=h.emitter;h.isStarted()&&r&&(!r.position||r.isEnabled())&&this._renderingManager.dispatchParticles(h)}}_bindFrameBuffer(){let p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const r=this.getScene();if(!r)return;const m=r.getEngine();this._renderTarget&&m.bindFramebuffer(this._renderTarget,this.isCube?p:void 0,void 0,void 0,this.ignoreCameraViewport,0,h)}_unbindFrameBuffer(p,h){this._renderTarget&&p.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(h)}))}_prepareFrame(p,h,r,m){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):m&&p.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(h,r)}_renderToTarget(p,h,r){var m,L;let z=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,C=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const v=this.getScene();if(!v)return;const O=v.getEngine();this._prepareFrame(v,p,z,h),null===(m=O._debugPushGroup)||void 0===m||m.call(O,`render to face #${p} layer #${z}`,2),this.is2DArray||this.is3D?(O.currentRenderPassId=this._renderPassIds[z],this.onBeforeRenderObservable.notifyObservers(z)):(O.currentRenderPassId=this._renderPassIds[p],this.onBeforeRenderObservable.notifyObservers(p));if(O.snapshotRendering&&1===O.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(O):this.skipInitialClear||O.clear(this.clearColor||v.clearColor,!0,!0,!0);else{var T;let m=null;const L=this.renderList?this.renderList:v.getActiveMeshes().data,x=this.renderList?this.renderList.length:v.getActiveMeshes().length;this.getCustomRenderList&&(m=this.getCustomRenderList(this.is2DArray||this.is3D?z:p,L,x)),m?this._prepareRenderingManager(m,m.length,C,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(L,x,C,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),m=L);for(const h of v._beforeRenderTargetClearStage)h.action(this,p,z);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(O):this.skipInitialClear||O.clear(this.clearColor||v.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||v.updateTransformMatrix(!0);for(const h of v._beforeRenderTargetDrawStage)h.action(this,p,z);this._renderingManager.render(this.customRenderFunction,m,this.renderParticles,this.renderSprites);for(const h of v._afterRenderTargetDrawStage)h.action(this,p,z);const P=(null===(T=this._texture)||void 0===T?void 0:T.generateMipMaps)??!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,p,this._postProcesses,this.ignoreCameraViewport):h&&v.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,p);for(const h of v._afterRenderTargetPostProcessStage)h.action(this,p,z);this._texture&&(this._texture.generateMipMaps=P),this._doNotChangeAspectRatio||v.updateTransformMatrix(!0),r&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),O):s.e.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}null===(L=O._debugPopGroup)||void 0===L||L.call(O,2),this._unbindFrameBuffer(O,p),this._texture&&this.isCube&&5===p&&O.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,m=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(p,h,r,m)}setRenderingAutoClearDepthStencil(p,h){this._renderingManager.setRenderingAutoClearDepthStencil(p,h),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const p=this.getSize(),h=new P(this.name,p,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return h.hasAlpha=this.hasAlpha,h.level=this.level,h.coordinatesMode=this.coordinatesMode,this.renderList&&(h.renderList=this.renderList.slice(0)),h}serialize(){if(!this.name)return null;const p=super.serialize();if(p.renderTargetSize=this.getRenderSize(),p.renderList=[],this.renderList)for(let h=0;h<this.renderList.length;h++)p.renderList.push(this.renderList[h].id);return p}disposeFramebufferObjects(){var p;null===(p=this._renderTarget)||void 0===p||p.dispose(!0)}releaseInternalTexture(){var p;null===(p=this._renderTarget)||void 0===p||p.releaseTextures(),this._texture=null}dispose(){var p;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const h=this.getScene();if(!h)return;let r=h.customRenderTargets.indexOf(this);r>=0&&h.customRenderTargets.splice(r,1);for(const p of h.cameras)r=p.customRenderTargets.indexOf(this),r>=0&&p.customRenderTargets.splice(r,1);null===(p=this._renderTarget)||void 0===p||p.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===P.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=P.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}P.REFRESHRATE_RENDER_ONCE=0,P.REFRESHRATE_RENDER_ONEVERYFRAME=1,P.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,z.e._CreateRenderTargetTexture=(p,h,r,m,L)=>new P(p,h,r,m)},2550:(p,h,r)=>{r.d(h,{e:()=>T,f:()=>x});var m=r(1407),L=r(2519),z=r(1136),C=r(1250),v=r(1517);r(2554);const O={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class T{constructor(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O;this._fullscreenViewport=new L.c(0,0,1,1);const r=h.positions??O.positions,z=h.indices??O.indices;this.engine=p,this._vertexBuffers={[m.e.PositionKind]:new m.e(p,r,m.e.PositionKind,!1,!1,2)},this._indexBuffer=p.createIndexBuffer(z),this._onContextRestoredObserver=p.onContextRestoredObservable.add((()=>{this._indexBuffer=p.createIndexBuffer(z);for(const p in this._vertexBuffers){this._vertexBuffers[p]._rebuild()}}))}setViewport(){let p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.engine.setViewport(p)}bindBuffers(p){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,p)}applyEffectWrapper(p){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(p.drawWrapper),this.bindBuffers(p.effect),p.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(p){return void 0!==p.renderTarget}render(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!p.effect.isReady())return;this.saveStates(),this.setViewport();const r=null===h?null:this._isRenderTargetTexture(h)?h.renderTarget:h;r&&this.engine.bindFramebuffer(r),this.applyEffectWrapper(p),this.draw(),r&&this.engine.unBindFramebuffer(r),this.restoreStates()}dispose(){const p=this._vertexBuffers[m.e.PositionKind];p&&(p.dispose(),delete this._vertexBuffers[m.e.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class x{static RegisterShaderCodeProcessing(p,h){h?x._CustomShaderCodeProcessing[p??""]=h:delete x._CustomShaderCodeProcessing[p??""]}static _GetShaderCodeProcessing(p){return x._CustomShaderCodeProcessing[p]??x._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(p){this.options.name=p}isReady(){var p;return(null===(p=this._drawWrapper.effect)||void 0===p?void 0:p.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(p){this._drawWrapper.effect=p}constructor(p){this.alphaMode=0,this.onEffectCreatedObservable=new z.c(void 0,!0),this.onApplyObservable=new z.c,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...p,name:p.name||"effectWrapper",engine:p.engine,uniforms:p.uniforms||p.uniformNames||[],uniformNames:void 0,samplers:p.samplers||p.samplerNames||[],samplerNames:void 0,attributeNames:p.attributeNames||["position"],uniformBuffers:p.uniformBuffers||[],defines:p.defines||"",useShaderStore:p.useShaderStore||!1,vertexUrl:p.vertexUrl||p.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:p.fragmentShader||"pass",indexParameters:p.indexParameters,blockCompilation:p.blockCompilation||!1,shaderLanguage:p.shaderLanguage||0,onCompiled:p.onCompiled||void 0,extraInitializations:p.extraInitializations||void 0,extraInitializationsAsync:p.extraInitializationsAsync||void 0,useAsPostProcess:p.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),p.vertexUrl||p.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new v.b(this.options.engine),this._webGPUReady=1===this.options.shaderLanguage;const h=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,h,this.options.extraInitializations)}_gatherImports(){let p=arguments.length>0&&void 0!==arguments[0]&&arguments[0],h=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(p&&this._webGPUReady?h.push(Promise.all([r.e(45).then(r.bind(r,11341))])):h.push(Promise.all([Promise.resolve().then(r.bind(r,2554))])))}_postConstructor(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0,m=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,m&&this._importPromises.push(...m);const L=this.options.engine.isWebGPU&&!x.ForceGLSL;this._gatherImports(L,this._importPromises),void 0!==r&&r(L,this._importPromises),L&&this._webGPUReady&&(this.options.shaderLanguage=1),p||this.updateEffect(h)}updateEffect(){let p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,m=arguments.length>3?arguments[3]:void 0,L=arguments.length>4?arguments[4]:void 0,z=arguments.length>5?arguments[5]:void 0,v=arguments.length>6?arguments[6]:void 0,O=arguments.length>7?arguments[7]:void 0;const T=x._GetShaderCodeProcessing(this.name);if(null!==T&&void 0!==T&&T.defineCustomBindings){var s,P;const m=(null===(s=h)||void 0===s?void 0:s.slice())??[];m.push(...this.options.uniforms);const L=(null===(P=r)||void 0===P?void 0:P.slice())??[];L.push(...this.options.samplers),p=T.defineCustomBindings(this.name,p,m,L),h=m,r=L}this.options.defines=p||"";const G=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let k;k=this.options.extraInitializationsAsync?async()=>{null===G||void 0===G||G(),await this.options.extraInitializationsAsync}:G,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:v??this._shaderPath.vertex,fragment:O??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:h||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:r||this.options.samplers,defines:null!==p?p:"",fallbacks:null,onCompiled:L??this.options.onCompiled,onError:z??null,indexParameters:m||this.options.indexParameters,processCodeAfterIncludes:null!==T&&void 0!==T&&T.processCodeAfterIncludes?(p,h)=>T.processCodeAfterIncludes(this.name,p,h):null,processFinalCode:null!==T&&void 0!==T&&T.processFinalCode?(p,h)=>T.processFinalCode(this.name,p,h):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:k},this.options.engine):this._drawWrapper.effect=new C.b(this._shaderPath,this.options.attributeNames,h||this.options.uniforms,r||this.options.samplerNames,this.options.engine,p,void 0,L||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,k),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var p,h;this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(p=x._GetShaderCodeProcessing(this.name))||void 0===p||null===(h=p.bindCustomBindings)||void 0===h||h.call(p,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this.effect.dispose()}}x.ForceGLSL=!1,x._CustomShaderCodeProcessing={}},2509:(p,h,r)=>{r.d(h,{e:()=>C,i:()=>m});var m,L,z=r(1140);!function(p){p[p.LOCAL=0]="LOCAL",p[p.WORLD=1]="WORLD",p[p.BONE=2]="BONE"}(m||(m={}));class C{}C.X=new z.m(1,0,0),C.Y=new z.m(0,1,0),C.Z=new z.m(0,0,1),function(p){p[p.X=0]="X",p[p.Y=1]="Y",p[p.Z=2]="Z"}(L||(L={}))},2506:(p,h,r)=>{r.d(h,{b:()=>m.g});r(2509),r(1322),r(1145),r(1456),r(2512),r(1328),r(1302);var m=r(1140);r(2519)},2512:(p,h,r)=>{r.d(h,{b:()=>v,f:()=>x,h:()=>s});var m,L=r(1173),z=r(1140),C=r(1145);!function(p){p[p.CW=0]="CW",p[p.CCW=1]="CCW"}(m||(m={}));class v{static Interpolate(p,h,r,m,L){const z=1-3*m+3*h,C=3*m-6*h,v=3*h;let O=p;for(let h=0;h<5;h++){const h=O*O;O-=(z*(h*O)+C*h+v*O-p)*(1/(3*z*h+2*C*O+v)),O=Math.min(1,Math.max(0,O))}return 3*Math.pow(1-O,2)*O*r+3*(1-O)*Math.pow(O,2)*L+Math.pow(O,3)}}class O{constructor(p){this._radians=p,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(p,h){const r=h.subtract(p),m=Math.atan2(r.y,r.x);return new O(m)}static BetweenTwoVectors(p,h){let r=p.lengthSquared()*h.lengthSquared();if(0===r)return new O(Math.PI/2);r=Math.sqrt(r);let m=p.dot(h)/r;m=(0,L.d)(m,-1,1);const z=Math.acos(m);return new O(z)}static FromRadians(p){return new O(p)}static FromDegrees(p){return new O(p*Math.PI/180)}}class T{constructor(p,h,r){this.startPoint=p,this.midPoint=h,this.endPoint=r;const m=Math.pow(h.x,2)+Math.pow(h.y,2),L=(Math.pow(p.x,2)+Math.pow(p.y,2)-m)/2,C=(m-Math.pow(r.x,2)-Math.pow(r.y,2))/2,v=(p.x-h.x)*(h.y-r.y)-(h.x-r.x)*(p.y-h.y);this.centerPoint=new z.k((L*(h.y-r.y)-C*(p.y-h.y))/v,((p.x-h.x)*C-(h.x-r.x)*L)/v),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=O.BetweenTwoPoints(this.centerPoint,this.startPoint);const T=this.startAngle.degrees();let x=O.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),s=O.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();x-T>180&&(x-=360),x-T<-180&&(x+=360),s-x>180&&(s-=360),s-x<-180&&(s+=360),this.orientation=x-T<0?0:1,this.angle=O.FromDegrees(0===this.orientation?T-s:s-T)}}class x{constructor(p,h){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new z.k(p,h))}addLineTo(p,h){if(this.closed)return this;const r=new z.k(p,h),m=this._points[this._points.length-1];return this._points.push(r),this._length+=r.subtract(m).length(),this}addArcTo(p,h,r,m){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const C=this._points[this._points.length-1],v=new z.k(p,h),O=new z.k(r,m),x=new T(C,v,O);let s=x.angle.radians()/L;0===x.orientation&&(s*=-1);let P=x.startAngle.radians()+s;for(let p=0;p<L;p++){const p=Math.cos(P)*x.radius+x.centerPoint.x,h=Math.sin(P)*x.radius+x.centerPoint.y;this.addLineTo(p,h),P+=s}return this}addQuadraticCurveTo(p,h,r,m){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const z=(p,h,r,m)=>(1-p)*(1-p)*h+2*p*(1-p)*r+p*p*m,C=this._points[this._points.length-1];for(let v=0;v<=L;v++){const O=v/L,T=z(O,C.x,p,r),x=z(O,C.y,h,m);this.addLineTo(T,x)}return this}addBezierCurveTo(p,h,r,m,L,z){let C=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const v=(p,h,r,m,L)=>(1-p)*(1-p)*(1-p)*h+3*p*(1-p)*(1-p)*r+3*p*p*(1-p)*m+p*p*p*L,O=this._points[this._points.length-1];for(let T=0;T<=C;T++){const x=T/C,s=v(x,O.x,p,r,L),P=v(x,O.y,h,m,z);this.addLineTo(s,P)}return this}isPointInside(p){let h=!1;const r=this._points.length;for(let m=r-1,L=0;L<r;m=L++){let r=this._points[m],z=this._points[L],C=z.x-r.x,v=z.y-r.y;if(Math.abs(v)>Number.EPSILON){if(v<0&&(r=this._points[L],C=-C,z=this._points[m],v=-v),p.y<r.y||p.y>z.y)continue;if(p.y===r.y&&p.x===r.x)return!0;{const m=v*(p.x-r.x)-C*(p.y-r.y);if(0===m)return!0;if(m<0)continue;h=!h}}else{if(p.y!==r.y)continue;if(z.x<=p.x&&p.x<=r.x||r.x<=p.x&&p.x<=z.x)return!0}}return h}close(){return this.closed=!0,this}length(){let p=this._length;if(this.closed){const h=this._points[this._points.length-1];p+=this._points[0].subtract(h).length()}return p}area(){const p=this._points.length;let h=0;for(let r=p-1,m=0;m<p;r=m++)h+=this._points[r].x*this._points[m].y-this._points[m].x*this._points[r].y;return.5*h}getPoints(){return this._points}getPointAtLengthPosition(p){if(p<0||p>1)return z.k.Zero();const h=p*this.length();let r=0;for(let p=0;p<this._points.length;p++){const m=(p+1)%this._points.length,L=this._points[p],C=this._points[m].subtract(L),v=C.length()+r;if(h>=r&&h<=v){const p=C.normalize(),m=h-r;return new z.k(L.x+p.x*m,L.y+p.y*m)}r=v}return z.k.Zero()}static StartingAt(p,h){return new x(p,h)}}class s{constructor(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0,m=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=p,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:z.m.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:z.b.Identity()};for(let h=0;h<p.length;h++)this._curve[h]=p[h].clone();this._raw=r||!1,this._alignTangentsWithPath=m,this._compute(h,m)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(p){return this._updatePointAtData(p).point}getTangentAt(p){let h=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(p,h),h?z.m.TransformCoordinates(z.m.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(p){let h=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(p,h),h?z.m.TransformCoordinates(z.m.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(p){let h=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(p,h),h?z.m.TransformCoordinates(z.m.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(p){return this.length()*p}getPreviousPointIndexAt(p){return this._updatePointAtData(p),this._pointAtData.previousPointArrayIndex}getSubPositionAt(p){return this._updatePointAtData(p),this._pointAtData.subPosition}getClosestPositionTo(p){let h=Number.MAX_VALUE,r=0;for(let m=0;m<this._curve.length-1;m++){const L=this._curve[m+0],C=this._curve[m+1].subtract(L).normalize(),v=this._distances[m+1]-this._distances[m+0],O=Math.min(Math.max(z.m.Dot(C,p.subtract(L).normalize()),0)*z.m.Distance(L,p)/v,1),T=z.m.Distance(L.add(C.scale(O*v)),p);T<h&&(h=T,r=(this._distances[m+0]+v*O)/this.length())}return r}slice(){let p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(p<0&&(p=1- -1*p%1),h<0&&(h=1- -1*h%1),p>h){const r=p;p=h,h=r}const r=this.getCurve(),m=this.getPointAt(p);let L=this.getPreviousPointIndexAt(p);const z=this.getPointAt(h),C=this.getPreviousPointIndexAt(h)+1,v=[];return 0!==p&&(L++,v.push(m)),v.push(...r.slice(L,C)),1===h&&1!==p||v.push(z),new s(v,this.getNormalAt(p),this._raw,this._alignTangentsWithPath)}update(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let h=0;h<p.length;h++)this._curve[h].x=p[h].x,this._curve[h].y=p[h].y,this._curve[h].z=p[h].z;return this._compute(h,r),this}_compute(p){let h=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this._curve.length;if(r<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[r-1]=this._curve[r-1].subtract(this._curve[r-2]),this._raw||this._tangents[r-1].normalize();const m=this._tangents[0],L=this._normalVector(m,p);let C,v,O,T,x;this._normals[0]=L,this._raw||this._normals[0].normalize(),this._binormals[0]=z.m.Cross(m,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let p=1;p<r;p++)C=this._getLastNonNullVector(p),p<r-1&&(v=this._getFirstNonNullVector(p),this._tangents[p]=h?v:C.add(v),this._tangents[p].normalize()),this._distances[p]=this._distances[p-1]+this._curve[p].subtract(this._curve[p-1]).length(),O=this._tangents[p],x=this._binormals[p-1],this._normals[p]=z.m.Cross(x,O),this._raw||(0===this._normals[p].length()?(T=this._normals[p-1],this._normals[p]=T.clone()):this._normals[p].normalize()),this._binormals[p]=z.m.Cross(O,this._normals[p]),this._raw||this._binormals[p].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(p){let h=1,r=this._curve[p+h].subtract(this._curve[p]);for(;0===r.length()&&p+h+1<this._curve.length;)h++,r=this._curve[p+h].subtract(this._curve[p]);return r}_getLastNonNullVector(p){let h=1,r=this._curve[p].subtract(this._curve[p-h]);for(;0===r.length()&&p>h+1;)h++,r=this._curve[p].subtract(this._curve[p-h]);return r}_normalVector(p,h){let r,m=p.length();if(0===m&&(m=1),void 0===h||null===h){let h;h=(0,L.w)(Math.abs(p.y)/m,1,C.d)?(0,L.w)(Math.abs(p.x)/m,1,C.d)?(0,L.w)(Math.abs(p.z)/m,1,C.d)?z.m.Zero():new z.m(0,0,1):new z.m(1,0,0):new z.m(0,-1,0),r=z.m.Cross(p,h)}else r=z.m.Cross(p,h),z.m.CrossToRef(r,p,r);return r.normalize(),r}_updatePointAtData(p){let h=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===p)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=p;const r=this.getPoints();if(p<=0)return this._setPointAtData(0,0,r[0],0,h);if(p>=1)return this._setPointAtData(1,1,r[r.length-1],r.length-1,h);let m,L=r[0],C=0;const v=p*this.length();for(let O=1;O<r.length;O++){m=r[O];const T=z.m.Distance(L,m);if(C+=T,C===v)return this._setPointAtData(p,1,m,O,h);if(C>v){const r=(C-v)/T,z=L.subtract(m),x=m.add(z.scaleInPlace(r));return this._setPointAtData(p,1-r,x,O-1,h)}L=m}return this._pointAtData}_setPointAtData(p,h,r,m,L){return this._pointAtData.point=r,this._pointAtData.position=p,this._pointAtData.subPosition=h,this._pointAtData.previousPointArrayIndex=m,this._pointAtData.interpolateReady=L,L&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=z.b.Identity();const p=this._pointAtData.previousPointArrayIndex;if(p!==this._tangents.length-1){const h=p+1,r=this._tangents[p].clone(),m=this._normals[p].clone(),L=this._binormals[p].clone(),C=this._tangents[h].clone(),v=this._normals[h].clone(),O=this._binormals[h].clone(),T=z.c.RotationQuaternionFromAxis(m,L,r),x=z.c.RotationQuaternionFromAxis(v,O,C);z.c.Slerp(T,x,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}},2519:(p,h,r)=>{r.d(h,{c:()=>m});class m{constructor(p,h,r,m){this.x=p,this.y=h,this.width=r,this.height=m}toGlobal(p,h){return new m(this.x*p,this.y*h,this.width*p,this.height*h)}toGlobalToRef(p,h,r){return r.x=this.x*p,r.y=this.y*h,r.width=this.width*p,r.height=this.height*h,this}clone(){return new m(this.x,this.y,this.width,this.height)}}},2504:(p,h,r)=>{r.d(h,{d:()=>T,g:()=>x});var m=r(1140),L=r(2506);const z=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],C=[()=>1,p=>p.y,p=>p.z,p=>p.x,p=>p.x*p.y,p=>p.y*p.z,p=>3*p.z*p.z-1,p=>p.x*p.z,p=>p.x*p.x-p.y*p.y],v=(p,h)=>z[p]*C[p](h),O=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class T{constructor(){this.preScaled=!1,this.l00=m.m.Zero(),this.l1_1=m.m.Zero(),this.l10=m.m.Zero(),this.l11=m.m.Zero(),this.l2_2=m.m.Zero(),this.l2_1=m.m.Zero(),this.l20=m.m.Zero(),this.l21=m.m.Zero(),this.l22=m.m.Zero()}addLight(p,h,r){L.b.Vector3[0].set(h.r,h.g,h.b);const m=L.b.Vector3[0],z=L.b.Vector3[1];m.scaleToRef(r,z),z.scaleToRef(v(0,p),L.b.Vector3[2]),this.l00.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(1,p),L.b.Vector3[2]),this.l1_1.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(2,p),L.b.Vector3[2]),this.l10.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(3,p),L.b.Vector3[2]),this.l11.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(4,p),L.b.Vector3[2]),this.l2_2.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(5,p),L.b.Vector3[2]),this.l2_1.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(6,p),L.b.Vector3[2]),this.l20.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(7,p),L.b.Vector3[2]),this.l21.addInPlace(L.b.Vector3[2]),z.scaleToRef(v(8,p),L.b.Vector3[2]),this.l22.addInPlace(L.b.Vector3[2])}scaleInPlace(p){this.l00.scaleInPlace(p),this.l1_1.scaleInPlace(p),this.l10.scaleInPlace(p),this.l11.scaleInPlace(p),this.l2_2.scaleInPlace(p),this.l2_1.scaleInPlace(p),this.l20.scaleInPlace(p),this.l21.scaleInPlace(p),this.l22.scaleInPlace(p)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(O[0]),this.l1_1.scaleInPlace(O[1]),this.l10.scaleInPlace(O[2]),this.l11.scaleInPlace(O[3]),this.l2_2.scaleInPlace(O[4]),this.l2_1.scaleInPlace(O[5]),this.l20.scaleInPlace(O[6]),this.l21.scaleInPlace(O[7]),this.l22.scaleInPlace(O[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(z[0]),this.l1_1.scaleInPlace(z[1]),this.l10.scaleInPlace(z[2]),this.l11.scaleInPlace(z[3]),this.l2_2.scaleInPlace(z[4]),this.l2_1.scaleInPlace(z[5]),this.l20.scaleInPlace(z[6]),this.l21.scaleInPlace(z[7]),this.l22.scaleInPlace(z[8])}updateFromArray(p){return m.m.FromArrayToRef(p[0],0,this.l00),m.m.FromArrayToRef(p[1],0,this.l1_1),m.m.FromArrayToRef(p[2],0,this.l10),m.m.FromArrayToRef(p[3],0,this.l11),m.m.FromArrayToRef(p[4],0,this.l2_2),m.m.FromArrayToRef(p[5],0,this.l2_1),m.m.FromArrayToRef(p[6],0,this.l20),m.m.FromArrayToRef(p[7],0,this.l21),m.m.FromArrayToRef(p[8],0,this.l22),this}updateFromFloatsArray(p){return m.m.FromFloatsToRef(p[0],p[1],p[2],this.l00),m.m.FromFloatsToRef(p[3],p[4],p[5],this.l1_1),m.m.FromFloatsToRef(p[6],p[7],p[8],this.l10),m.m.FromFloatsToRef(p[9],p[10],p[11],this.l11),m.m.FromFloatsToRef(p[12],p[13],p[14],this.l2_2),m.m.FromFloatsToRef(p[15],p[16],p[17],this.l2_1),m.m.FromFloatsToRef(p[18],p[19],p[20],this.l20),m.m.FromFloatsToRef(p[21],p[22],p[23],this.l21),m.m.FromFloatsToRef(p[24],p[25],p[26],this.l22),this}static FromArray(p){return(new T).updateFromArray(p)}static FromPolynomial(p){const h=new T;return h.l00=p.xx.scale(.376127).add(p.yy.scale(.376127)).add(p.zz.scale(.376126)),h.l1_1=p.y.scale(.977204),h.l10=p.z.scale(.977204),h.l11=p.x.scale(.977204),h.l2_2=p.xy.scale(1.16538),h.l2_1=p.yz.scale(1.16538),h.l20=p.zz.scale(1.34567).subtract(p.xx.scale(.672834)).subtract(p.yy.scale(.672834)),h.l21=p.zx.scale(1.16538),h.l22=p.xx.scale(1.16538).subtract(p.yy.scale(1.16538)),h.l1_1.scaleInPlace(-1),h.l11.scaleInPlace(-1),h.l2_1.scaleInPlace(-1),h.l21.scaleInPlace(-1),h.scaleInPlace(Math.PI),h}}class x{constructor(){this.x=m.m.Zero(),this.y=m.m.Zero(),this.z=m.m.Zero(),this.xx=m.m.Zero(),this.yy=m.m.Zero(),this.zz=m.m.Zero(),this.xy=m.m.Zero(),this.yz=m.m.Zero(),this.zx=m.m.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=T.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(p){L.b.Vector3[0].copyFromFloats(p.r,p.g,p.b);const h=L.b.Vector3[0];this.xx.addInPlace(h),this.yy.addInPlace(h),this.zz.addInPlace(h)}scaleInPlace(p){this.x.scaleInPlace(p),this.y.scaleInPlace(p),this.z.scaleInPlace(p),this.xx.scaleInPlace(p),this.yy.scaleInPlace(p),this.zz.scaleInPlace(p),this.yz.scaleInPlace(p),this.zx.scaleInPlace(p),this.xy.scaleInPlace(p)}updateFromHarmonics(p){return this._harmonics=p,this.x.copyFrom(p.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(p.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(p.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(p.l00),L.b.Vector3[0].copyFrom(p.l20).scaleInPlace(.247708),L.b.Vector3[1].copyFrom(p.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(L.b.Vector3[0]).addInPlace(L.b.Vector3[1]),this.yy.copyFrom(p.l00),this.yy.scaleInPlace(.886277).subtractInPlace(L.b.Vector3[0]).subtractInPlace(L.b.Vector3[1]),this.zz.copyFrom(p.l00),L.b.Vector3[0].copyFrom(p.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(L.b.Vector3[0]),this.yz.copyFrom(p.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(p.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(p.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(p){return(new x).updateFromHarmonics(p)}static FromArray(p){const h=new x;return m.m.FromArrayToRef(p[0],0,h.x),m.m.FromArrayToRef(p[1],0,h.y),m.m.FromArrayToRef(p[2],0,h.z),m.m.FromArrayToRef(p[3],0,h.xx),m.m.FromArrayToRef(p[4],0,h.yy),m.m.FromArrayToRef(p[5],0,h.zz),m.m.FromArrayToRef(p[6],0,h.yz),m.m.FromArrayToRef(p[7],0,h.zx),m.m.FromArrayToRef(p[8],0,h.xy),h}}},2530:(p,h,r)=>{r.d(h,{c:()=>T});var m=r(1140),L=r(1173),z=r(2504),C=r(1145),v=r(1322);class O{constructor(p,h,r,m){this.name=p,this.worldAxisForNormal=h,this.worldAxisForFileX=r,this.worldAxisForFileY=m}}class T{static ConvertCubeMapTextureToSphericalPolynomial(p){var h;if(!p.isCube)return null;null===(h=p.getScene())||void 0===h||h.getEngine().flushFramebuffer();const r=p.getSize().width,m=p.readPixels(0,void 0,void 0,!1),L=p.readPixels(1,void 0,void 0,!1);let z,C;p.isRenderTarget?(z=p.readPixels(3,void 0,void 0,!1),C=p.readPixels(2,void 0,void 0,!1)):(z=p.readPixels(2,void 0,void 0,!1),C=p.readPixels(3,void 0,void 0,!1));const v=p.readPixels(4,void 0,void 0,!1),O=p.readPixels(5,void 0,void 0,!1),T=p.gammaSpace;let x=0;return 1!=p.textureType&&2!=p.textureType||(x=1),new Promise((p=>{Promise.all([L,m,z,C,v,O]).then((h=>{let[m,L,z,C,v,O]=h;const s={size:r,right:L,left:m,up:z,down:C,front:v,back:O,format:5,type:x,gammaSpace:T};p(this.ConvertCubeMapToSphericalPolynomial(s))}))}))}static _AreaElement(p,h){return Math.atan2(p*h,Math.sqrt(p*p+h*h+1))}static ConvertCubeMapToSphericalPolynomial(p){const h=new z.d;let r=0;const m=2/p.size,O=m,T=.5*m,x=T-1;for(let z=0;z<6;z++){const s=this._FileFaces[z],P=p[s.name];let G=x;const k=5===p.format?4:3;for(let z=0;z<p.size;z++){let M=x;for(let O=0;O<p.size;O++){const x=s.worldAxisForFileX.scale(M).add(s.worldAxisForFileY.scale(G)).add(s.worldAxisForNormal);x.normalize();const H=this._AreaElement(M-T,G-T)-this._AreaElement(M-T,G+T)-this._AreaElement(M+T,G-T)+this._AreaElement(M+T,G+T);let I=P[z*p.size*k+O*k+0],U=P[z*p.size*k+O*k+1],E=P[z*p.size*k+O*k+2];isNaN(I)&&(I=0),isNaN(U)&&(U=0),isNaN(E)&&(E=0),0===p.type&&(I/=255,U/=255,E/=255),p.gammaSpace&&(I=Math.pow((0,L.d)(I),C.n),U=Math.pow((0,L.d)(U),C.n),E=Math.pow((0,L.d)(E),C.n));const j=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const p=Math.max(I,U,E);if(p>j){const h=j/p;I*=h,U*=h,E*=h}}else I=(0,L.d)(I,0,j),U=(0,L.d)(U,0,j),E=(0,L.d)(E,0,j);const c=new v.e(I,U,E);h.addLight(x,c,H),r+=H,M+=m}G+=O}}const s=6*(4*Math.PI)/6/r;return h.scaleInPlace(s),h.convertIncidentRadianceToIrradiance(),h.convertIrradianceToLambertianRadiance(),z.g.FromHarmonics(h)}}T._FileFaces=[new O("right",new m.m(1,0,0),new m.m(0,0,-1),new m.m(0,-1,0)),new O("left",new m.m(-1,0,0),new m.m(0,0,1),new m.m(0,-1,0)),new O("up",new m.m(0,1,0),new m.m(1,0,0),new m.m(0,0,1)),new O("down",new m.m(0,-1,0),new m.m(1,0,0),new m.m(0,0,-1)),new O("front",new m.m(0,0,1),new m.m(1,0,0),new m.m(0,-1,0)),new O("back",new m.m(0,0,-1),new m.m(-1,0,0),new m.m(0,-1,0))],T.MAX_HDRI_VALUE=4096,T.PRESERVE_CLAMPED_COLORS=!1},2537:(p,h,r)=>{r.d(h,{e:()=>O,h:()=>P,l:()=>s});r(1109),r(2542);var m=r(2548),L=r(1245),z=r(1160),C=r(1309);class v extends m.e{getClassName(){return"PassPostProcess"}constructor(p,h){super(p,"pass",null,null,h,arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,arguments.length>3?arguments[3]:void 0,arguments.length>4?arguments[4]:void 0,arguments.length>5?arguments[5]:void 0,void 0,arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,void 0,null,arguments.length>7&&void 0!==arguments[7]&&arguments[7])}_gatherImports(p,h){p?(this._webGPUReady=!0,h.push(Promise.all([r.e(41).then(r.bind(r,11329))]))):h.push(Promise.all([r.e(42).then(r.bind(r,11332))])),super._gatherImports(p,h)}static _Parse(p,h,r,m){return C.c.Parse((()=>new v(p.name,p.options,h,p.renderTargetSamplingMode,p._engine,p.reusable)),p,r,m)}}(0,z.i)("BABYLON.PassPostProcess",v);m.e;function O(p,h,r,L,z,C,v,O){const T=h.getEngine();return h.isReady=!1,z=z??h.samplingMode,L=L??h.type,C=C??h.format,v=v??h.width,O=O??h.height,-1===L&&(L=0),new Promise((x=>{const s=new m.e("postprocess",p,null,null,1,null,z,T,!1,void 0,L,void 0,null,!1,C);s.externalTextureSamplerBinding=!0;const P=T.createRenderTargetTexture({width:v,height:O},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:z,type:L,format:C});s.onEffectCreatedObservable.addOnce((p=>{p.executeWhenCompiled((()=>{s.onApply=p=>{p._bindTexture("textureSampler",h),p.setFloat2("scale",1,1)},r.postProcessManager.directRender([s],P,!0),T.restoreDefaultFramebuffer(),T._releaseTexture(h),s&&s.dispose(),P._swapAndDie(h),h.type=L,h.format=5,h.isReady=!0,x(h)}))}))}))}let T,x;function s(p){T||(T=new Float32Array(1),x=new Int32Array(T.buffer)),T[0]=p;const h=x[0];let r=h>>16&32768,m=h>>12&2047;const L=h>>23&255;return L<103?r:L>142?(r|=31744,r|=(255==L?0:1)&&8388607&h,r):L<113?(m|=2048,r|=(m>>114-L)+(m>>113-L&1),r):(r|=L-112<<10|m>>1,r+=1&m,r)}function P(p){const h=(32768&p)>>15,r=(31744&p)>>10,m=1023&p;return 0===r?(h?-1:1)*Math.pow(2,-14)*(m/Math.pow(2,10)):31==r?m?NaN:1/0*(h?-1:1):(h?-1:1)*Math.pow(2,r-15)*(1+m/Math.pow(2,10))}L.c._RescalePostProcessFactory=p=>new v("rescale",1,null,2,p,!1,0)},2548:(p,h,r)=>{r.d(h,{e:()=>k});var m=r(1118),L=r(1349),z=r(1136),C=r(1140),v=r(1250),O=r(1127),T=r(1309),x=r(1160),s=r(1245),P=r(1373),G=r(2550);s.c.prototype.setTextureFromPostProcess=function(p,h,r){var m;let L=null;h&&(h._forcedOutputTexture?L=h._forcedOutputTexture:h._textures.data[h._currentRenderTextureInd]&&(L=h._textures.data[h._currentRenderTextureInd])),this._bindTexture(p,(null===(m=L)||void 0===m?void 0:m.texture)??null,r)},s.c.prototype.setTextureFromPostProcessOutput=function(p,h,r){var m;this._bindTexture(p,(null===h||void 0===h||null===(m=h._outputTexture)||void 0===m?void 0:m.texture)??null,r)},v.b.prototype.setTextureFromPostProcess=function(p,h){this._engine.setTextureFromPostProcess(this._samplers[p],h,p)},v.b.prototype.setTextureFromPostProcessOutput=function(p,h){this._engine.setTextureFromPostProcessOutput(this._samplers[p],h,p)};class k{static get ForceGLSL(){return G.f.ForceGLSL}static set ForceGLSL(p){G.f.ForceGLSL=p}static RegisterShaderCodeProcessing(p,h){G.f.RegisterShaderCodeProcessing(p,h)}get name(){return this._effectWrapper.name}set name(p){this._effectWrapper.name=p}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(p){this._effectWrapper.alphaMode=p}get samples(){return this._samples}set samples(p){this._samples=Math.min(p,this._engine.getCaps().maxMSAASamples),this._textures.forEach((p=>{p.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(p){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),p&&(this._onActivateObserver=this.onActivateObservable.add(p))}set onSizeChanged(p){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(p)}set onApply(p){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(p)}set onBeforeRender(p){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(p)}set onAfterRender(p){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(p)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(p){this._forcedOutputTexture=p}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(p,h,r,m,v,O){var T;let x=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,s=arguments.length>7?arguments[7]:void 0,P=arguments.length>8?arguments[8]:void 0,M=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,H=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,I=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",U=arguments.length>12?arguments[12]:void 0,E=arguments.length>13&&void 0!==arguments[13]&&arguments[13],j=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,c=arguments.length>15?arguments[15]:void 0,W=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new L.g(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new C.k(1,1),this._texelSize=C.k.Zero(),this.onActivateObservable=new z.c,this.onSizeChangedObservable=new z.c,this.onApplyObservable=new z.c,this.onBeforeRenderObservable=new z.c,this.onAfterRenderObservable=new z.c;let K,A=1,X=null;if(r&&!Array.isArray(r)){const p=r;r=p.uniforms??null,m=p.samplers??null,A=p.size??1,O=p.camera??null,x=p.samplingMode??1,s=p.engine,P=p.reusable,M=Array.isArray(p.defines)?p.defines.join("\n"):p.defines??null,H=p.textureType??0,I=p.vertexUrl??"postprocess",U=p.indexParameters,E=p.blockCompilation??!1,j=p.textureFormat??5,c=p.shaderLanguage??0,X=p.uniformBuffers??null,W=p.extraInitializations,K=p.effectWrapper}else v&&(A="number"===typeof v?v:{width:v.width,height:v.height});const t=!!K;if(this._effectWrapper=K??new G.f({name:p,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:h,engine:s||(null===(T=O)||void 0===T?void 0:T.getScene().getEngine()),uniforms:r,samplers:m,uniformBuffers:X,defines:M,vertexUrl:I,indexParameters:U,blockCompilation:E,shaderLanguage:c,extraInitializations:W}),this.name=p,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=O?(this._camera=O,this._scene=O.getScene(),O.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):s&&(this._engine=s,this._engine.postProcesses.push(this)),this._options=A,this.renderTargetSamplingMode=x||1,this._reusable=P||!1,this._textureType=H,this._textureFormat=j,this._shaderLanguage=c||0,this._samplers=m||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=h,this._vertexUrl=I,this._parameters=r||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=X||[],this._indexParameters=U,!t){this._webGPUReady=1===this._shaderLanguage;const p=[];this._gatherImports(this._engine.isWebGPU&&!k.ForceGLSL,p),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(E,M,W,p)}}_gatherImports(){let p=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?p.push(Promise.all([r.e(45).then(r.bind(r,11341))])):p.push(Promise.all([Promise.resolve().then(r.bind(r,2554))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(p){return this._disposeTextures(),this._shareOutputWithPostProcess=p,this}useOwnOutput(){0==this._textures.length&&(this._textures=new L.g(2)),this._shareOutputWithPostProcess=null}updateEffect(){let p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,m=arguments.length>3?arguments[3]:void 0,L=arguments.length>4?arguments[4]:void 0,z=arguments.length>5?arguments[5]:void 0,C=arguments.length>6?arguments[6]:void 0,v=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(p,h,r,m,L,z,C,v),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(p,h){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let m=0;m<this._textureCache.length;m++)if(this._textureCache[m].texture.width===p.width&&this._textureCache[m].texture.height===p.height&&this._textureCache[m].postProcessChannel===r&&this._textureCache[m].texture._generateDepthBuffer===h.generateDepthBuffer&&this._textureCache[m].texture.samples===h.samples)return this._textureCache[m].texture;const m=this._engine.createRenderTargetTexture(p,h);return this._textureCache.push({texture:m,postProcessChannel:r,lastUsedRenderId:-1}),m}_flushTextureCache(){const p=this._renderId;for(let h=this._textureCache.length-1;h>=0;h--)if(p-this._textureCache[h].lastUsedRenderId>100){let p=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[h].texture){p=!0;break}p||(this._textureCache[h].texture.dispose(),this._textureCache.splice(h,1))}}resize(p,h){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,m=arguments.length>3&&void 0!==arguments[3]&&arguments[3],L=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=p,this.height=h;let z=null;if(r)for(let p=0;p<r._postProcesses.length;p++)if(null!==r._postProcesses[p]){z=r._postProcesses[p];break}const C={width:this.width,height:this.height},v={generateMipMaps:m,generateDepthBuffer:L||z===this,generateStencilBuffer:(L||z===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(C,v,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(C,v,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let p;if(this._shareOutputWithPostProcess)p=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)p=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let h;p=this.inputTexture;for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture===p){h=this._textureCache[r];break}h&&(h.lastUsedRenderId=this._renderId)}return p}activate(p){var h,r;let m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,L=arguments.length>2?arguments[2]:void 0;const z=(p=p||this._camera).getScene(),C=z.getEngine(),v=C.getCaps().maxTextureSize,O=(m?m.width:this._engine.getRenderWidth(!0))*this._options|0,T=(m?m.height:this._engine.getRenderHeight(!0))*this._options|0;let x=this._options.width||O,s=this._options.height||T;const G=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let k=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const p=C.currentViewport;p&&(x*=p.width,s*=p.height)}(G||this.alwaysForcePOT)&&(this._options.width||(x=C.needPOTTextures?(0,P.f)(x,v,this.scaleMode):x),this._options.height||(s=C.needPOTTextures?(0,P.f)(s,v,this.scaleMode):s)),this.width===x&&this.height===s&&(k=this._getTarget())||this.resize(x,s,p,G,L),this._textures.forEach((p=>{p.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(p,this.samples)})),this._flushTextureCache(),this._renderId++}return k||(k=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(O/x,T/s),this._engine.bindFramebuffer(k,0,O,T,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(k,0,void 0,void 0,this.forceFullscreenViewport)),null===(h=(r=this._engine)._debugInsertMarker)||void 0===h||h.call(r,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(p),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:z.clearColor,z._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),k}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let p;var h;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),p=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(h=p)||void 0===h?void 0:h.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let p=this._textureCache.length-1;p>=0;p--)this._textureCache[p].texture.dispose();this._textureCache.length=0}setPrePassRenderer(p){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=p.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(p){let h;if(p=p||this._camera,this._disposeTextures(),this._scene&&(h=this._scene.postProcesses.indexOf(this),-1!==h&&this._scene.postProcesses.splice(h,1)),this._parentContainer){const p=this._parentContainer.postProcesses.indexOf(this);p>-1&&this._parentContainer.postProcesses.splice(p,1),this._parentContainer=null}if(h=this._engine.postProcesses.indexOf(this),-1!==h&&this._engine.postProcesses.splice(h,1),p){if(p.detachPostProcess(this),h=p._postProcesses.indexOf(this),0===h&&p._postProcesses.length>0){const p=this._camera._getFirstPostProcess();p&&p.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const p=T.c.Serialize(this),h=this.getCamera()||this._scene&&this._scene.activeCamera;return p.customType="BABYLON."+this.getClassName(),p.cameraId=h?h.id:null,p.reusable=this._reusable,p.textureType=this._textureType,p.fragmentUrl=this._fragmentUrl,p.parameters=this._parameters,p.samplers=this._samplers,p.uniformBuffers=this._uniformBuffers,p.options=this._options,p.defines=this._postProcessDefines,p.textureFormat=this._textureFormat,p.vertexUrl=this._vertexUrl,p.indexParameters=this._indexParameters,p}clone(){const p=this.serialize();p._engine=this._engine,p.cameraId=null;const h=k.Parse(p,this._scene,"");return h?(h.onActivateObservable=this.onActivateObservable.clone(),h.onSizeChangedObservable=this.onSizeChangedObservable.clone(),h.onApplyObservable=this.onApplyObservable.clone(),h.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),h.onAfterRenderObservable=this.onAfterRenderObservable.clone(),h._prePassEffectConfiguration=this._prePassEffectConfiguration,h):null}static Parse(p,h,r){const m=(0,x.e)(p.customType);if(!m||!m._Parse)return null;const L=h?h.getCameraById(p.cameraId):null;return m._Parse(p,L,h,r)}static _Parse(p,h,r,m){return T.c.Parse((()=>new k(p.name,p.fragmentUrl,p.parameters,p.samplers,p.options,h,p.renderTargetSamplingMode,p._engine,p.reusable,p.defines,p.textureType,p.vertexUrl,p.indexParameters,!1,p.textureFormat)),p,r,m)}}(0,m.d)([(0,O.K)()],k.prototype,"uniqueId",void 0),(0,m.d)([(0,O.K)()],k.prototype,"name",null),(0,m.d)([(0,O.K)()],k.prototype,"width",void 0),(0,m.d)([(0,O.K)()],k.prototype,"height",void 0),(0,m.d)([(0,O.K)()],k.prototype,"renderTargetSamplingMode",void 0),(0,m.d)([(0,O.o)()],k.prototype,"clearColor",void 0),(0,m.d)([(0,O.K)()],k.prototype,"autoClear",void 0),(0,m.d)([(0,O.K)()],k.prototype,"forceAutoClearInAlphaMode",void 0),(0,m.d)([(0,O.K)()],k.prototype,"alphaMode",null),(0,m.d)([(0,O.K)()],k.prototype,"alphaConstants",void 0),(0,m.d)([(0,O.K)()],k.prototype,"enablePixelPerfectMode",void 0),(0,m.d)([(0,O.K)()],k.prototype,"forceFullscreenViewport",void 0),(0,m.d)([(0,O.K)()],k.prototype,"scaleMode",void 0),(0,m.d)([(0,O.K)()],k.prototype,"alwaysForcePOT",void 0),(0,m.d)([(0,O.K)("samples")],k.prototype,"_samples",void 0),(0,m.d)([(0,O.K)()],k.prototype,"adaptScaleToCurrentViewport",void 0),(0,x.i)("BABYLON.PostProcess",k)},2554:(p,h,r)=>{r.r(h),r.d(h,{postprocessVertexShader:()=>z});const m="postprocessVertexShader",L="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";r(1254).d.ShadersStore[m]=L;const z={name:m,shader:L}}}]);