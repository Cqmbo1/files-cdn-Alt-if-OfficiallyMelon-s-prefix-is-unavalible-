"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[6],{2473:(p,h,r)=>{r.d(h,{e:()=>m});class m{get underlyingResource(){return this._webGLTexture}constructor(){let p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,h=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=h,!p&&(p=h.createTexture(),!p))throw new Error("Unable to create webGL texture");this.set(p)}setUsage(){}set(p){this._webGLTexture=p}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(p){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(p)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const p of this._MSAARenderBuffers)this._context.deleteRenderbuffer(p);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var p;let h=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(p=this._MSAARenderBuffers)||void 0===p?void 0:p[h])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},2462:(p,h,r)=>{r.r(h),r.d(h,{ThinEngine:()=>E});var m=r(1266),L=r(2469),z=r(1238),C=r(1204);class v{constructor(){this.shaderLanguage=0}postProcessor(p,h,r,m,L){if(L.drawBuffersExtensionDisabled){const h=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;p=p.replace(h,"")}return p}}const O=/(flat\s)?\s*varying\s*.*/;class T{constructor(){this.shaderLanguage=0}attributeProcessor(p){return p.replace("attribute","in")}varyingCheck(p,h){return O.test(p)}varyingProcessor(p,h){return p.replace("varying",h?"in":"out")}postProcessor(p,h,r){const m=-1!==p.search(/#extension.+GL_EXT_draw_buffers.+require/);if(p=(p=p.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),r){const h=-1!==p.search(/layout *\(location *= *0\) *out/g);p=(p=(p=(p=(p=(p=(p=p.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(m||h?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==h.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+p}return p}}var x=r(2471),s=r(1373),P=r(1245),G=r(2473),k=r(1281),M=r(1250),H=r(1232),I=r(1262);class U{}class E extends P.c{get name(){return this._name}set name(p){this._name=p}get version(){return this._webGLVersion}static get ShadersRepository(){return M.b.ShadersRepository}static set ShadersRepository(p){M.b.ShadersRepository=p}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(p){this._framebufferDimensionsObject=p}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(p,h,r,L){if(r=r||{},super(h??r.antialias,r,L),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!p)return;let C=null;if(p.getContext){if(C=p,this._renderingCanvas=C,void 0===r.preserveDrawingBuffer&&(r.preserveDrawingBuffer=!1),void 0===r.xrCompatible&&(r.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const p=navigator.userAgent;for(const h of E.ExceptionList){const m=h.key,L=h.targets;if(new RegExp(m).test(p)){if(h.capture&&h.captureConstraint){const r=h.capture,m=h.captureConstraint,L=new RegExp(r).exec(p);if(L&&L.length>0){if(parseInt(L[L.length-1])>=m)continue}}for(const p of L)switch(p){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":r.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=p=>{p.preventDefault(),this._contextWasLost=!0,z.e.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},C.addEventListener("webglcontextlost",this._onContextLost,!1),C.addEventListener("webglcontextrestored",this._onContextRestored,!1),r.powerPreference=r.powerPreference||"high-performance"),this._badDesktopOS&&(r.xrCompatible=!1),!r.disableWebGL2Support)try{this._gl=C.getContext("webgl2",r)||C.getContext("experimental-webgl2",r),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(p){}if(!this._gl){if(!C)throw new Error("The provided canvas is null or undefined.");try{this._gl=C.getContext("webgl",r)||C.getContext("experimental-webgl",r)}catch(p){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=p,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const h=this._gl.getContextAttributes();h&&(r.stencil=h.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==r.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let p=0;p<this._caps.maxVertexAttribs;p++)this._currentBufferPointers[p]=new U;this._shaderProcessor=this.webGLVersion>1?new T:new v;const O=`Babylon.js v${E.Version}`;z.e.Log(O+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",O);const x=(0,m.y)(this._gl);x.validateShaderPrograms=this.validateShaderPrograms,x.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(p){return null}areAllEffectsReady(){for(const p in this._compiledEffects){if(!this._compiledEffects[p].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const p=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=p&&(this._glRenderer=this._gl.getParameter(p.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(p.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const p=this._gl.getExtension("WEBGL_draw_buffers");if(null!==p){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=p.drawBuffersWEBGL.bind(p),this._caps.maxDrawBuffers=this._gl.getParameter(p.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let h=0;h<16;h++)this._gl["COLOR_ATTACHMENT"+h+"_WEBGL"]=p["COLOR_ATTACHMENT"+h+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const p=this._gl.getExtension("WEBGL_depth_texture");null!=p&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=p.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const p=this._gl.getExtension("OES_vertex_array_object");null!=p&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=p.createVertexArrayOES.bind(p),this._gl.bindVertexArray=p.bindVertexArrayOES.bind(p),this._gl.deleteVertexArray=p.deleteVertexArrayOES.bind(p))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const p=this._gl.getExtension("ANGLE_instanced_arrays");null!=p?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=p.drawArraysInstancedANGLE.bind(p),this._gl.drawElementsInstanced=p.drawElementsInstancedANGLE.bind(p),this._gl.vertexAttribDivisor=p.vertexAttribDivisorANGLE.bind(p)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const p=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),h=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);p&&h&&(this._caps.highPrecisionShaderSupported=0!==p.precision&&0!==h.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const p=this._gl.getExtension("EXT_blend_minmax");null!=p&&(this._caps.blendMinMax=!0,this._gl.MAX=p.MAX_EXT,this._gl.MIN=p.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const p=this._gl.getExtension("EXT_sRGB");null!=p&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:p.SRGB_EXT,SRGB8:p.SRGB_ALPHA_EXT,SRGB8_ALPHA8:p.SRGB_ALPHA_EXT})}if(this._creationOptions){const p=this._creationOptions.forceSRGBBufferSupportState;void 0!==p&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&p)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let p=0;p<this._maxSimultaneousTextures;p++)this._nextFreeTextureSlots.push(p);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const p=this._workingCanvas.getContext("2d");p&&(this._workingContext=p)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const p=this.getGlInfo();return p&&p.renderer?p.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(p,h,r){let m=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const L=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=L;let z=0;if(h&&p){let h=!0;if(this._currentRenderTarget){var C;const r=null===(C=this._currentRenderTarget.texture)||void 0===C?void 0:C.format;if(8===r||9===r||10===r||11===r){var v;const r=null===(v=this._currentRenderTarget.texture)||void 0===v?void 0:v.type;7===r||5===r?(E._TempClearColorUint32[0]=255*p.r,E._TempClearColorUint32[1]=255*p.g,E._TempClearColorUint32[2]=255*p.b,E._TempClearColorUint32[3]=255*p.a,this._gl.clearBufferuiv(this._gl.COLOR,0,E._TempClearColorUint32),h=!1):(E._TempClearColorInt32[0]=255*p.r,E._TempClearColorInt32[1]=255*p.g,E._TempClearColorInt32[2]=255*p.b,E._TempClearColorInt32[3]=255*p.a,this._gl.clearBufferiv(this._gl.COLOR,0,E._TempClearColorInt32),h=!1)}}h&&(this._gl.clearColor(p.r,p.g,p.b,void 0!==p.a?p.a:1),z|=this._gl.COLOR_BUFFER_BIT)}r&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),z|=this._gl.DEPTH_BUFFER_BIT),m&&(this._gl.clearStencil(0),z|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(z)}_viewport(p,h,r,m){p===this._viewportCached.x&&h===this._viewportCached.y&&r===this._viewportCached.z&&m===this._viewportCached.w||(this._viewportCached.x=p,this._viewportCached.y=h,this._viewportCached.z=r,this._viewportCached.w=m,this._gl.viewport(p,h,r,m))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0,m=arguments.length>3?arguments[3]:void 0,L=arguments.length>4?arguments[4]:void 0,C=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const O=p;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=p,this._bindUnboundFramebuffer(O._framebuffer);const T=this._gl;var x;if(!p.isMulti)if(p.is2DArray||p.is3D)T.framebufferTextureLayer(T.FRAMEBUFFER,T.COLOR_ATTACHMENT0,null===(x=p.texture._hardwareTexture)||void 0===x?void 0:x.underlyingResource,C,v),O._currentLOD=C;else if(p.isCube){var s;T.framebufferTexture2D(T.FRAMEBUFFER,T.COLOR_ATTACHMENT0,T.TEXTURE_CUBE_MAP_POSITIVE_X+h,null===(s=p.texture._hardwareTexture)||void 0===s?void 0:s.underlyingResource,C)}else if(O._currentLOD!==C){var P;T.framebufferTexture2D(T.FRAMEBUFFER,T.COLOR_ATTACHMENT0,T.TEXTURE_2D,null===(P=p.texture._hardwareTexture)||void 0===P?void 0:P.underlyingResource,C),O._currentLOD=C}const G=p._depthStencilTexture;if(G){p.is3D&&(p.texture.width===G.width&&p.texture.height===G.height&&p.texture.depth===G.depth||z.e.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const r=p._depthStencilTextureWithStencil?T.DEPTH_STENCIL_ATTACHMENT:T.DEPTH_ATTACHMENT;var k;if(p.is2DArray||p.is3D)T.framebufferTextureLayer(T.FRAMEBUFFER,r,null===(k=G._hardwareTexture)||void 0===k?void 0:k.underlyingResource,C,v);else if(p.isCube){var M;T.framebufferTexture2D(T.FRAMEBUFFER,r,T.TEXTURE_CUBE_MAP_POSITIVE_X+h,null===(M=G._hardwareTexture)||void 0===M?void 0:M.underlyingResource,C)}else{var H;T.framebufferTexture2D(T.FRAMEBUFFER,r,T.TEXTURE_2D,null===(H=G._hardwareTexture)||void 0===H?void 0:H.underlyingResource,C)}}O._MSAAFramebuffer&&this._bindUnboundFramebuffer(O._MSAAFramebuffer),this._cachedViewport&&!L?this.setViewport(this._cachedViewport,r,m):(r||(r=p.width,C&&(r/=Math.pow(2,C))),m||(m=p.height,C&&(m/=Math.pow(2,C))),this._viewport(0,0,r,m)),this.wipeCaches()}setState(p){let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0,m=arguments.length>3&&void 0!==arguments[3]&&arguments[3],L=arguments.length>4?arguments[4]:void 0,z=arguments.length>5?arguments[5]:void 0,C=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==p||r)&&(this._depthCullingState.cull=p);const v=this.cullBackFaces??L??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==v||r)&&(this._depthCullingState.cullFace=v),this.setZOffset(h),this.setZOffsetUnits(C);const O=m?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==O||r)&&(this._depthCullingState.frontFace=O),this._stencilStateComposer.stencilMaterial=z}_bindUnboundFramebuffer(p){this._currentFramebuffer!==p&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,p),this._currentFramebuffer=p)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(p){const h=this._getTextureTarget(p);this._bindTextureDirectly(h,p,!0),this._gl.generateMipmap(h),this._bindTextureDirectly(h,null)}unBindFramebuffer(p){var h;let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],m=arguments.length>2?arguments[2]:void 0;const L=p;this._currentRenderTarget=null;const z=this._gl;if(L._MSAAFramebuffer){if(p.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(p,r,m);z.bindFramebuffer(z.READ_FRAMEBUFFER,L._MSAAFramebuffer),z.bindFramebuffer(z.DRAW_FRAMEBUFFER,L._framebuffer),z.blitFramebuffer(0,0,p.width,p.height,0,0,p.width,p.height,z.COLOR_BUFFER_BIT,z.NEAREST)}null===(h=p.texture)||void 0===h||!h.generateMipMaps||r||p.isCube||this.generateMipmaps(p.texture),m&&(L._MSAAFramebuffer&&this._bindUnboundFramebuffer(L._framebuffer),m()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(p,h,r){return this._createVertexBuffer(p,this._gl.STATIC_DRAW)}_createVertexBuffer(p,h){const r=this._gl.createBuffer();if(!r)throw new Error("Unable to create vertex buffer");const m=new x.c(r);return this.bindArrayBuffer(m),"number"!==typeof p?p instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(p),h),m.capacity=4*p.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,p,h),m.capacity=p.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(p),h),m.capacity=p),this._resetVertexBufferBinding(),m.references=1,m}createDynamicVertexBuffer(p,h){return this._createVertexBuffer(p,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(p,h,r){const m=this._gl.createBuffer(),L=new x.c(m);if(!m)throw new Error("Unable to create index buffer");this.bindIndexBuffer(L);const z=this._normalizeIndexData(p);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,z,h?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),L.references=1,L.is32Bits=4===z.BYTES_PER_ELEMENT,L}_normalizeIndexData(p){if(2===p.BYTES_PER_ELEMENT)return p;if(this._caps.uintIndices){if(p instanceof Uint32Array)return p;for(let h=0;h<p.length;h++)if(p[h]>=65535)return new Uint32Array(p);return new Uint16Array(p)}return new Uint16Array(p)}bindArrayBuffer(p){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(p,this._gl.ARRAY_BUFFER)}bindUniformBlock(p,h,r){const m=p.program,L=this._gl.getUniformBlockIndex(m,h);this._gl.uniformBlockBinding(m,L,r)}bindIndexBuffer(p){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(p,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(p,h){(this._vaoRecordInProgress||this._currentBoundBuffer[h]!==p)&&(this._gl.bindBuffer(h,p?p.underlyingResource:null),this._currentBoundBuffer[h]=p)}updateArrayBuffer(p){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,p)}_vertexAttribPointer(p,h,r,m,L,z,C){const v=this._currentBufferPointers[h];if(!v)return;let O=!1;v.active?(v.buffer!==p&&(v.buffer=p,O=!0),v.size!==r&&(v.size=r,O=!0),v.type!==m&&(v.type=m,O=!0),v.normalized!==L&&(v.normalized=L,O=!0),v.stride!==z&&(v.stride=z,O=!0),v.offset!==C&&(v.offset=C,O=!0)):(O=!0,v.active=!0,v.index=h,v.size=r,v.type=m,v.normalized=L,v.stride=z,v.offset=C,v.buffer=p),(O||this._vaoRecordInProgress)&&(this.bindArrayBuffer(p),m===this._gl.UNSIGNED_INT||m===this._gl.INT?this._gl.vertexAttribIPointer(h,r,m,z,C):this._gl.vertexAttribPointer(h,r,m,L,z,C))}_bindIndexBufferWithCache(p){null!=p&&this._cachedIndexBuffer!==p&&(this._cachedIndexBuffer=p,this.bindIndexBuffer(p),this._uintIndicesCurrentlySet=p.is32Bits)}_bindVertexBuffersAttributes(p,h,r){const m=h.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let L=0;L<m.length;L++){const z=h.getAttributeLocation(L);if(z>=0){const h=m[L];let C=null;if(r&&(C=r[h]),C||(C=p[h]),!C)continue;this._gl.enableVertexAttribArray(z),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[z]=!0);const v=C.getBuffer();v&&(this._vertexAttribPointer(v,z,C.getSize(),C.type,C.normalized,C.byteStride,C.byteOffset),C.getIsInstanced()&&(this._gl.vertexAttribDivisor(z,C.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(z),this._currentInstanceBuffers.push(v))))}}}recordVertexArrayObject(p,h,r,m){const L=this._gl.createVertexArray();if(!L)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(L),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(p,r,m),this.bindIndexBuffer(h),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),L}bindVertexArrayObject(p,h){this._cachedVertexArrayObject!==p&&(this._cachedVertexArrayObject=p,this._gl.bindVertexArray(p),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=h&&h.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(p,h,r,m,L){if(this._cachedVertexBuffers!==p||this._cachedEffectForVertexBuffers!==L){this._cachedVertexBuffers=p,this._cachedEffectForVertexBuffers=L;const h=L.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let z=0;for(let C=0;C<h;C++)if(C<r.length){const h=L.getAttributeLocation(C);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(p,h,r[C],this._gl.FLOAT,!1,m,z)),z+=4*r[C]}}this._bindIndexBufferWithCache(h)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(p,h,r,m){this._cachedVertexBuffers===p&&this._cachedEffectForVertexBuffers===r||(this._cachedVertexBuffers=p,this._cachedEffectForVertexBuffers=r,this._bindVertexBuffersAttributes(p,r,m)),this._bindIndexBufferWithCache(h)}unbindInstanceAttributes(){let p;for(let h=0,r=this._currentInstanceLocations.length;h<r;h++){const r=this._currentInstanceBuffers[h];p!=r&&r.references&&(p=r,this.bindArrayBuffer(r));const m=this._currentInstanceLocations[h];this._gl.vertexAttribDivisor(m,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(p){this._gl.deleteVertexArray(p)}_releaseBuffer(p){return p.references--,0===p.references&&(this._deleteBuffer(p),!0)}_deleteBuffer(p){this._gl.deleteBuffer(p.underlyingResource)}updateAndBindInstancesBuffer(p,h,r){if(this.bindArrayBuffer(p),h&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,h),void 0!==r[0].index)this.bindInstancesBuffer(p,r,!0);else for(let h=0;h<4;h++){const m=r[h];this._vertexAttribArraysEnabled[m]||(this._gl.enableVertexAttribArray(m),this._vertexAttribArraysEnabled[m]=!0),this._vertexAttribPointer(p,m,4,this._gl.FLOAT,!1,64,16*h),this._gl.vertexAttribDivisor(m,1),this._currentInstanceLocations.push(m),this._currentInstanceBuffers.push(p)}}bindInstancesBuffer(p,h){let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(p);let m=0;if(r)for(let p=0;p<h.length;p++){m+=4*h[p].attributeSize}for(let r=0;r<h.length;r++){const L=h[r];void 0===L.index&&(L.index=this._currentEffect.getAttributeLocationByName(L.attributeName)),L.index<0||(this._vertexAttribArraysEnabled[L.index]||(this._gl.enableVertexAttribArray(L.index),this._vertexAttribArraysEnabled[L.index]=!0),this._vertexAttribPointer(p,L.index,L.attributeSize,L.attributeType||this._gl.FLOAT,L.normalized||!1,m,L.offset),this._gl.vertexAttribDivisor(L.index,void 0===L.divisor?1:L.divisor),this._currentInstanceLocations.push(L.index),this._currentInstanceBuffers.push(p))}}disableInstanceAttributeByName(p){if(!this._currentEffect)return;const h=this._currentEffect.getAttributeLocationByName(p);this.disableInstanceAttribute(h)}disableInstanceAttribute(p){let h,r=!1;for(;-1!==(h=this._currentInstanceLocations.indexOf(p));)this._currentInstanceLocations.splice(h,1),this._currentInstanceBuffers.splice(h,1),r=!0,h=this._currentInstanceLocations.indexOf(p);r&&(this._gl.vertexAttribDivisor(p,0),this.disableAttributeByIndex(p))}disableAttributeByIndex(p){this._gl.disableVertexAttribArray(p),this._vertexAttribArraysEnabled[p]=!1,this._currentBufferPointers[p].active=!1}draw(p,h,r,m){this.drawElementsType(p?0:1,h,r,m)}drawPointClouds(p,h,r){this.drawArraysType(2,p,h,r)}drawUnIndexed(p,h,r,m){this.drawArraysType(p?0:1,h,r,m)}drawElementsType(p,h,r,m){this.applyStates(),this._reportDrawCall();const L=this._drawMode(p),z=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,C=this._uintIndicesCurrentlySet?4:2;m?this._gl.drawElementsInstanced(L,r,z,h*C,m):this._gl.drawElements(L,r,z,h*C)}drawArraysType(p,h,r,m){this.applyStates(),this._reportDrawCall();const L=this._drawMode(p);m?this._gl.drawArraysInstanced(L,h,r,m):this._gl.drawArrays(L,h,r)}_drawMode(p){switch(p){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(p){this._compiledEffects[p._key]&&delete this._compiledEffects[p._key];const h=p.getPipelineContext();h&&this._deletePipelineContext(h)}_deletePipelineContext(p){const h=p;h&&h.program&&(h.program.__SPECTOR_rebuildProgram=null,(0,I.i)(h),this._gl.deleteProgram(h.program))}_getGlobalDefines(p){return(0,H.h)(p,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(p,h,r,L,z,C,v,O,T){let x=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,s=arguments.length>10?arguments[10]:void 0;const P="string"===typeof p?p:p.vertexToken||p.vertexSource||p.vertexElement||p.vertex,G="string"===typeof p?p:p.fragmentToken||p.fragmentSource||p.fragmentElement||p.fragment,k=this._getGlobalDefines();let H=z??h.defines??"";k&&(H+=k);const I=P+"+"+G+"@"+H;if(this._compiledEffects[I]){const p=this._compiledEffects[I];return v&&p.isReady()&&v(p),p._refCount++,p}this._gl&&(0,m.y)(this._gl);const U=new M.b(p,h,r,L,this,z,C,v,O,T,I,h.shaderLanguage??x,h.extraInitializationsAsync??s);return this._compiledEffects[I]=U,U}_getShaderSource(p){return this._gl.getShaderSource(p)}createRawShaderProgram(p,h,r,L){let z=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const C=(0,m.y)(this._gl);return C._contextWasLost=this._contextWasLost,C.validateShaderPrograms=this.validateShaderPrograms,(0,m.r)(p,h,r,L||this._gl,z)}createShaderProgram(p,h,r,L,z){let C=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const v=(0,m.y)(this._gl);return v._contextWasLost=this._contextWasLost,v.validateShaderPrograms=this.validateShaderPrograms,(0,m.u)(p,h,r,L,z||this._gl,C)}inlineShaderCode(p){return p}createPipelineContext(p){if(this._gl){(0,m.y)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const h=(0,m.n)(this._gl,p);return h.engine=this,h}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(p){return(0,m.d)(p,this._gl,this.validateShaderPrograms)}_preparePipelineContext(p,h,r,L,z,C,v,O,T,x,s){const P=(0,m.y)(this._gl);return P._contextWasLost=this._contextWasLost,P.validateShaderPrograms=this.validateShaderPrograms,P._createShaderProgramInjection=this._createShaderProgram.bind(this),P.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),P.createShaderProgramInjection=this.createShaderProgram.bind(this),P.loadFileInjection=this._loadFile.bind(this),(0,m.g)(p,h,r,L,z,C,v,O,T,x,s)}_createShaderProgram(p,h,r,L){let z=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,m.b)(p,h,r,L,z)}_isRenderingStateCompiled(p){const h=p;return!this._isDisposed&&!h._isDisposed&&(!!this._gl.getProgramParameter(h.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(h),!0))}_executeWhenRenderingStateIsCompiled(p,h){(0,m.c)(p,h)}getUniforms(p,h){const r=new Array,m=p;for(let p=0;p<h.length;p++)r.push(this._gl.getUniformLocation(m.program,h[p]));return r}getAttributes(p,h){const r=[],m=p;for(let p=0;p<h.length;p++)try{r.push(this._gl.getAttribLocation(m.program,h[p]))}catch(p){r.push(-1)}return r}enableEffect(p){(p=null!==p&&(0,L.b)(p)?p.effect:p)&&p!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(p),this._currentEffect=p,p.onBind&&p.onBind(p),p._onBindObservable&&p._onBindObservable.notifyObservers(p))}setInt(p,h){return!!p&&(this._gl.uniform1i(p,h),!0)}setInt2(p,h,r){return!!p&&(this._gl.uniform2i(p,h,r),!0)}setInt3(p,h,r,m){return!!p&&(this._gl.uniform3i(p,h,r,m),!0)}setInt4(p,h,r,m,L){return!!p&&(this._gl.uniform4i(p,h,r,m,L),!0)}setIntArray(p,h){return!!p&&(this._gl.uniform1iv(p,h),!0)}setIntArray2(p,h){return!(!p||h.length%2!==0)&&(this._gl.uniform2iv(p,h),!0)}setIntArray3(p,h){return!(!p||h.length%3!==0)&&(this._gl.uniform3iv(p,h),!0)}setIntArray4(p,h){return!(!p||h.length%4!==0)&&(this._gl.uniform4iv(p,h),!0)}setUInt(p,h){return!!p&&(this._gl.uniform1ui(p,h),!0)}setUInt2(p,h,r){return!!p&&(this._gl.uniform2ui(p,h,r),!0)}setUInt3(p,h,r,m){return!!p&&(this._gl.uniform3ui(p,h,r,m),!0)}setUInt4(p,h,r,m,L){return!!p&&(this._gl.uniform4ui(p,h,r,m,L),!0)}setUIntArray(p,h){return!!p&&(this._gl.uniform1uiv(p,h),!0)}setUIntArray2(p,h){return!(!p||h.length%2!==0)&&(this._gl.uniform2uiv(p,h),!0)}setUIntArray3(p,h){return!(!p||h.length%3!==0)&&(this._gl.uniform3uiv(p,h),!0)}setUIntArray4(p,h){return!(!p||h.length%4!==0)&&(this._gl.uniform4uiv(p,h),!0)}setArray(p,h){return!!p&&(!(h.length<1)&&(this._gl.uniform1fv(p,h),!0))}setArray2(p,h){return!(!p||h.length%2!==0)&&(this._gl.uniform2fv(p,h),!0)}setArray3(p,h){return!(!p||h.length%3!==0)&&(this._gl.uniform3fv(p,h),!0)}setArray4(p,h){return!(!p||h.length%4!==0)&&(this._gl.uniform4fv(p,h),!0)}setMatrices(p,h){return!!p&&(this._gl.uniformMatrix4fv(p,!1,h),!0)}setMatrix3x3(p,h){return!!p&&(this._gl.uniformMatrix3fv(p,!1,h),!0)}setMatrix2x2(p,h){return!!p&&(this._gl.uniformMatrix2fv(p,!1,h),!0)}setFloat(p,h){return!!p&&(this._gl.uniform1f(p,h),!0)}setFloat2(p,h,r){return!!p&&(this._gl.uniform2f(p,h,r),!0)}setFloat3(p,h,r,m){return!!p&&(this._gl.uniform3f(p,h,r,m),!0)}setFloat4(p,h,r,m,L){return!!p&&(this._gl.uniform4f(p,h,r,m,L),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const p=this._colorWrite;this._gl.colorMask(p,p,p,p)}}wipeCaches(p){this.preventCacheWipeBetweenFrames&&!p||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),p&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(p,h){const r=this._gl;let m=r.NEAREST,L=r.NEAREST;switch(p){case 11:m=r.LINEAR,L=h?r.LINEAR_MIPMAP_NEAREST:r.LINEAR;break;case 3:m=r.LINEAR,L=h?r.LINEAR_MIPMAP_LINEAR:r.LINEAR;break;case 8:m=r.NEAREST,L=h?r.NEAREST_MIPMAP_LINEAR:r.NEAREST;break;case 4:m=r.NEAREST,L=h?r.NEAREST_MIPMAP_NEAREST:r.NEAREST;break;case 5:m=r.NEAREST,L=h?r.LINEAR_MIPMAP_NEAREST:r.LINEAR;break;case 6:m=r.NEAREST,L=h?r.LINEAR_MIPMAP_LINEAR:r.LINEAR;break;case 7:m=r.NEAREST,L=r.LINEAR;break;case 1:m=r.NEAREST,L=r.NEAREST;break;case 9:m=r.LINEAR,L=h?r.NEAREST_MIPMAP_NEAREST:r.NEAREST;break;case 10:m=r.LINEAR,L=h?r.NEAREST_MIPMAP_LINEAR:r.NEAREST;break;case 2:m=r.LINEAR,L=r.LINEAR;break;case 12:m=r.LINEAR,L=r.NEAREST}return{min:L,mag:m}}_createTexture(){const p=this._gl.createTexture();if(!p)throw new Error("Unable to create texture");return p}_createHardwareTexture(){return new G.e(this._createTexture(),this._gl)}_createInternalTexture(p,h){let r,m=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,L=!1,C=0,v=3,O=5,T=!1,x=1;void 0!==h&&"object"===typeof h?(L=!!h.generateMipMaps,C=void 0===h.type?0:h.type,v=void 0===h.samplingMode?3:h.samplingMode,O=void 0===h.format?5:h.format,T=void 0!==h.useSRGBBuffer&&h.useSRGBBuffer,x=h.samples??1,r=h.label):L=!!h,T&&(T=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==C||this._caps.textureFloatLinearFiltering)&&(2!==C||this._caps.textureHalfFloatLinearFiltering)||(v=1),1!==C||this._caps.textureFloat||(C=0,z.e.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const s=this._gl,P=new k.e(this,m),G=p.width||p,M=p.height||p,H=p.depth||0,I=p.layers||0,U=this._getSamplingParameters(v,L),E=0!==I?s.TEXTURE_2D_ARRAY:0!==H?s.TEXTURE_3D:s.TEXTURE_2D,j=this._getRGBABufferInternalSizedFormat(C,O,T),c=this._getInternalFormat(O),W=this._getWebGLTextureType(C);return this._bindTextureDirectly(E,P),0!==I?(P.is2DArray=!0,s.texImage3D(E,0,j,G,M,I,0,c,W,null)):0!==H?(P.is3D=!0,s.texImage3D(E,0,j,G,M,H,0,c,W,null)):s.texImage2D(E,0,j,G,M,0,c,W,null),s.texParameteri(E,s.TEXTURE_MAG_FILTER,U.mag),s.texParameteri(E,s.TEXTURE_MIN_FILTER,U.min),s.texParameteri(E,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(E,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),L&&this._gl.generateMipmap(E),this._bindTextureDirectly(E,null),P._useSRGBBuffer=T,P.baseWidth=G,P.baseHeight=M,P.width=G,P.height=M,P.depth=I,P.isReady=!0,P.samples=x,P.generateMipMaps=L,P.samplingMode=v,P.type=C,P.format=O,P.label=r,this._internalTexturesCache.push(P),P}_getUseSRGBBuffer(p,h){return p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||h)}createTexture(p,h,r,m){var L=this;let z=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,C=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,O=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,T=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,x=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,s=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,P=arguments.length>11?arguments[11]:void 0,G=arguments.length>12?arguments[12]:void 0,M=arguments.length>13?arguments[13]:void 0,H=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(p,h,r,m,z,C,v,(function(){for(var p=arguments.length,h=new Array(p),r=0;r<p;r++)h[r]=arguments[r];return L._prepareWebGLTexture(...h,x)}),((p,h,r,L,z,C)=>{const v=this._gl,O=r.width===p&&r.height===h;z._creationFlags=M??0;const T=this._getTexImageParametersForCreateTexture(z.format,z._useSRGBBuffer);if(O)return v.texImage2D(v.TEXTURE_2D,0,T.internalFormat,T.format,T.type,r),!1;const x=this._caps.maxTextureSize;if(r.width>x||r.height>x||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=p,this._workingCanvas.height=h,this._workingContext.drawImage(r,0,0,r.width,r.height,0,0,p,h),v.texImage2D(v.TEXTURE_2D,0,T.internalFormat,T.format,T.type,this._workingCanvas),z.width=p,z.height=h,!1);{const p=new k.e(this,2);this._bindTextureDirectly(v.TEXTURE_2D,p,!0),v.texImage2D(v.TEXTURE_2D,0,T.internalFormat,T.format,T.type,r),this._rescaleTexture(p,z,m,T.format,(()=>{this._releaseTexture(p),this._bindTextureDirectly(v.TEXTURE_2D,z,!0),C()}))}return!0}),O,T,x,s,P,G,H)}_getTexImageParametersForCreateTexture(p,h){let r,m;return 1===this.webGLVersion?(r=this._getInternalFormat(p,h),m=r):(r=this._getInternalFormat(p,!1),m=this._getRGBABufferInternalSizedFormat(0,p,h)),{internalFormat:m,format:r,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(p,h,r,m,L){}_unpackFlipY(p){this._unpackFlipYCached!==p&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,p?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=p))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(p){return p.isCube?this._gl.TEXTURE_CUBE_MAP:p.is3D?this._gl.TEXTURE_3D:p.is2DArray||p.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(p,h){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const m=this._getTextureTarget(h),L=this._getSamplingParameters(p,h.useMipMaps||r);this._setTextureParameterInteger(m,this._gl.TEXTURE_MAG_FILTER,L.mag,h),this._setTextureParameterInteger(m,this._gl.TEXTURE_MIN_FILTER,L.min),r&&(h.generateMipMaps=!0,this._gl.generateMipmap(m)),this._bindTextureDirectly(m,null),h.samplingMode=p}updateTextureDimensions(p,h,r){}updateTextureWrappingMode(p,h){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,m=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const L=this._getTextureTarget(p);null!==h&&(this._setTextureParameterInteger(L,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(h),p),p._cachedWrapU=h),null!==r&&(this._setTextureParameterInteger(L,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r),p),p._cachedWrapV=r),(p.is2DArray||p.is3D)&&null!==m&&(this._setTextureParameterInteger(L,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(m),p),p._cachedWrapR=m),this._bindTextureDirectly(L,null)}_uploadCompressedDataToTextureDirectly(p,h,r,m,L){let z=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,C=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const v=this._gl;let O=v.TEXTURE_2D;if(p.isCube&&(O=v.TEXTURE_CUBE_MAP_POSITIVE_X+z),p._useSRGBBuffer)switch(h){case 37492:case 36196:this._caps.etc2?h=v.COMPRESSED_SRGB8_ETC2:p._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?h=v.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:p._useSRGBBuffer=!1;break;case 36492:h=v.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:h=v.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?h=v.COMPRESSED_SRGB_S3TC_DXT1_EXT:p._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?h=v.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:p._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?h=v.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:p._useSRGBBuffer=!1;break;default:p._useSRGBBuffer=!1}this._gl.compressedTexImage2D(O,C,h,r,m,0,L)}_uploadDataToTextureDirectly(p,h){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,m=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,L=arguments.length>4?arguments[4]:void 0,z=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const C=this._gl,v=this._getWebGLTextureType(p.type),O=this._getInternalFormat(p.format),T=void 0===L?this._getRGBABufferInternalSizedFormat(p.type,p.format,p._useSRGBBuffer):this._getInternalFormat(L,p._useSRGBBuffer);this._unpackFlipY(p.invertY);let x=C.TEXTURE_2D;p.isCube&&(x=C.TEXTURE_CUBE_MAP_POSITIVE_X+r);const s=Math.round(Math.log(p.width)*Math.LOG2E),P=Math.round(Math.log(p.height)*Math.LOG2E),G=z?p.width:Math.pow(2,Math.max(s-m,0)),k=z?p.height:Math.pow(2,Math.max(P-m,0));C.texImage2D(x,m,T,G,k,0,O,v,h)}updateTextureData(p,h,r,m,L,z){let C=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,v=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,O=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const T=this._gl,x=this._getWebGLTextureType(p.type),s=this._getInternalFormat(p.format);this._unpackFlipY(p.invertY);let P=T.TEXTURE_2D,G=T.TEXTURE_2D;p.isCube&&(G=T.TEXTURE_CUBE_MAP_POSITIVE_X+C,P=T.TEXTURE_CUBE_MAP),this._bindTextureDirectly(P,p,!0),T.texSubImage2D(G,v,r,m,L,z,s,x,h),O&&this._gl.generateMipmap(G),this._bindTextureDirectly(P,null)}_uploadArrayBufferViewToTexture(p,h){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,m=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const L=this._gl,z=p.isCube?L.TEXTURE_CUBE_MAP:L.TEXTURE_2D;this._bindTextureDirectly(z,p,!0),this._uploadDataToTextureDirectly(p,h,r,m),this._bindTextureDirectly(z,null,!0)}_prepareWebGLTextureContinuation(p,h,r,m,L){const z=this._gl;if(!z)return;const C=this._getSamplingParameters(L,!r);z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MAG_FILTER,C.mag),z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,C.min),r||m||z.generateMipmap(z.TEXTURE_2D),this._bindTextureDirectly(z.TEXTURE_2D,null),h&&h.removePendingData(p),p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear()}_prepareWebGLTexture(p,h,r,m,L,z,C,v,O,T){const x=this.getCaps().maxTextureSize,P=Math.min(x,this.needPOTTextures?(0,s.f)(m.width,x):m.width),G=Math.min(x,this.needPOTTextures?(0,s.f)(m.height,x):m.height),k=this._gl;k&&(p._hardwareTexture?(this._bindTextureDirectly(k.TEXTURE_2D,p,!0),this._unpackFlipY(void 0===L||!!L),p.baseWidth=m.width,p.baseHeight=m.height,p.width=P,p.height=G,p.isReady=!0,p.type=-1!==p.type?p.type:0,p.format=-1!==p.format?p.format:T??(".jpg"!==h||p._useSRGBBuffer?5:4),v(P,G,m,h,p,(()=>{this._prepareWebGLTextureContinuation(p,r,z,C,O)}))||this._prepareWebGLTextureContinuation(p,r,z,C,O)):r&&r.removePendingData(p))}_getInternalFormatFromDepthTextureFormat(p,h,r){const m=this._gl;if(!h)return m.STENCIL_INDEX8;let L=r?m.DEPTH_STENCIL:m.DEPTH_COMPONENT;return this.webGLVersion>1?15===p?L=m.DEPTH_COMPONENT16:16===p?L=m.DEPTH_COMPONENT24:17===p||13===p?L=r?m.DEPTH24_STENCIL8:m.DEPTH_COMPONENT24:14===p?L=m.DEPTH_COMPONENT32F:18===p&&(L=r?m.DEPTH32F_STENCIL8:m.DEPTH_COMPONENT32F):L=m.DEPTH_COMPONENT16,L}_setupFramebufferDepthAttachments(p,h,r,m){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,z=arguments.length>5?arguments[5]:void 0;const C=this._gl;z=z??(p?13:14);const v=this._getInternalFormatFromDepthTextureFormat(z,h,p);return p&&h?this._createRenderBuffer(r,m,L,C.DEPTH_STENCIL,v,C.DEPTH_STENCIL_ATTACHMENT):h?this._createRenderBuffer(r,m,L,v,v,C.DEPTH_ATTACHMENT):p?this._createRenderBuffer(r,m,L,v,v,C.STENCIL_ATTACHMENT):null}_createRenderBuffer(p,h,r,m,L,z){let C=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const v=this._gl.createRenderbuffer();return this._updateRenderBuffer(v,p,h,r,m,L,z,C)}_updateRenderBuffer(p,h,r,m,L,z,C){let v=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const O=this._gl;return O.bindRenderbuffer(O.RENDERBUFFER,p),m>1&&O.renderbufferStorageMultisample?O.renderbufferStorageMultisample(O.RENDERBUFFER,m,z,h,r):O.renderbufferStorage(O.RENDERBUFFER,L,h,r),O.framebufferRenderbuffer(O.FRAMEBUFFER,C,O.RENDERBUFFER,p),v&&O.bindRenderbuffer(O.RENDERBUFFER,null),p}_releaseTexture(p){this._deleteTexture(p._hardwareTexture),this.unbindAllTextures();const h=this._internalTexturesCache.indexOf(p);-1!==h&&this._internalTexturesCache.splice(h,1),p._lodTextureHigh&&p._lodTextureHigh.dispose(),p._lodTextureMid&&p._lodTextureMid.dispose(),p._lodTextureLow&&p._lodTextureLow.dispose(),p._irradianceTexture&&p._irradianceTexture.dispose()}_deleteTexture(p){null===p||void 0===p||p.release()}_setProgram(p){this._currentProgram!==p&&((0,m.k)(p,this._gl),this._currentProgram=p)}bindSamplers(p){const h=p.getPipelineContext();this._setProgram(h.program);const r=p.getSamplers();for(let h=0;h<r.length;h++){const m=p.getUniform(r[h]);m&&(this._boundUniforms[h]=m)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(p,h){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],m=arguments.length>3&&void 0!==arguments[3]&&arguments[3],L=!1;const C=h&&h._associatedChannel>-1;r&&C&&(this._activeChannel=h._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==h||m){if(this._activateCurrentTexture(),h&&h.isMultiview)throw z.e.Error(["_bindTextureDirectly called with a multiview texture!",p,h]),"_bindTextureDirectly called with a multiview texture!";var v;this._gl.bindTexture(p,(null===h||void 0===h||null===(v=h._hardwareTexture)||void 0===v?void 0:v.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=h,h&&(h._associatedChannel=this._activeChannel)}else r&&(L=!0,this._activateCurrentTexture());return C&&!r&&this._bindSamplerUniformToChannel(h._associatedChannel,this._activeChannel),L}_bindTexture(p,h,r){if(void 0===p)return;h&&(h._associatedChannel=p),this._activeChannel=p;const m=h?this._getTextureTarget(h):this._gl.TEXTURE_2D;this._bindTextureDirectly(m,h)}unbindAllTextures(){for(let p=0;p<this._maxSimultaneousTextures;p++)this._activeChannel=p,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(p,h,r,m){void 0!==p&&(h&&(this._boundUniforms[p]=h),this._setTexture(p,r))}_bindSamplerUniformToChannel(p,h){const r=this._boundUniforms[p];r&&r._currentState!==h&&(this._gl.uniform1i(r,h),r._currentState=h)}_getTextureWrapMode(p){switch(p){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(p,h){let r,m=arguments.length>2&&void 0!==arguments[2]&&arguments[2],L=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!h)return null!=this._boundTexturesCache[p]&&(this._activeChannel=p,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(h.video){this._activeChannel=p;const r=h.getInternalTexture();r&&(r._associatedChannel=p),h.update()}else if(4===h.delayLoadState)return h.delayLoad(),!1;r=L?h.depthStencilTexture:h.isReady()?h.getInternalTexture():h.isCube?this.emptyCubeTexture:h.is3D?this.emptyTexture3D:h.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!m&&r&&(r._associatedChannel=p);let z=!0;this._boundTexturesCache[p]===r&&(m||this._bindSamplerUniformToChannel(r._associatedChannel,p),z=!1),this._activeChannel=p;const C=this._getTextureTarget(r);if(z&&this._bindTextureDirectly(C,r,m),r&&!r.isMultiview){if(r.isCube&&r._cachedCoordinatesMode!==h.coordinatesMode){r._cachedCoordinatesMode=h.coordinatesMode;const p=3!==h.coordinatesMode&&5!==h.coordinatesMode?1:0;h.wrapU=p,h.wrapV=p}r._cachedWrapU!==h.wrapU&&(r._cachedWrapU=h.wrapU,this._setTextureParameterInteger(C,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(h.wrapU),r)),r._cachedWrapV!==h.wrapV&&(r._cachedWrapV=h.wrapV,this._setTextureParameterInteger(C,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(h.wrapV),r)),r.is3D&&r._cachedWrapR!==h.wrapR&&(r._cachedWrapR=h.wrapR,this._setTextureParameterInteger(C,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(h.wrapR),r)),this._setAnisotropicLevel(C,r,h.anisotropicFilteringLevel)}return!0}setTextureArray(p,h,r,m){if(void 0!==p&&h){this._textureUnits&&this._textureUnits.length===r.length||(this._textureUnits=new Int32Array(r.length));for(let h=0;h<r.length;h++){const m=r[h].getInternalTexture();m?(this._textureUnits[h]=p+h,m._associatedChannel=p+h):this._textureUnits[h]=-1}this._gl.uniform1iv(h,this._textureUnits);for(let p=0;p<r.length;p++)this._setTexture(this._textureUnits[p],r[p],!0)}}_setAnisotropicLevel(p,h,r){const m=this._caps.textureAnisotropicFilterExtension;11!==h.samplingMode&&3!==h.samplingMode&&2!==h.samplingMode&&(r=1),m&&h._cachedAnisotropicFilteringLevel!==r&&(this._setTextureParameterFloat(p,m.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r,this._caps.maxAnisotropy),h),h._cachedAnisotropicFilteringLevel=r)}_setTextureParameterFloat(p,h,r,m){this._bindTextureDirectly(p,m,!0,!0),this._gl.texParameterf(p,h,r)}_setTextureParameterInteger(p,h,r,m){m&&this._bindTextureDirectly(p,m,!0,!0),this._gl.texParameteri(p,h,r)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let p=0;p<this._caps.maxVertexAttribs;p++)this.disableAttributeByIndex(p)}else for(let p=0,h=this._vertexAttribArraysEnabled.length;p<h;p++)p>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[p]||this.disableAttributeByIndex(p)}releaseEffects(){const p=Object.keys(this._compiledEffects);for(const h of p){this._compiledEffects[h].dispose()}this._compiledEffects={}}dispose(){var p;((0,C.g)()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(p=this._gl.getExtension("WEBGL_lose_context"))||void 0===p||p.loseContext());(0,m.v)(this._gl)}attachContextLostEvent(p){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",p,!1)}attachContextRestoredEvent(p){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",p,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(p){const h=this._gl;for(;h.getError()!==h.NO_ERROR;);let r=!0;const m=h.createTexture();h.bindTexture(h.TEXTURE_2D,m),h.texImage2D(h.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(p),1,1,0,h.RGBA,this._getWebGLTextureType(p),null),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST);const L=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,L),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,m,0);const z=h.checkFramebufferStatus(h.FRAMEBUFFER);if(r=r&&z===h.FRAMEBUFFER_COMPLETE,r=r&&h.getError()===h.NO_ERROR,r&&(h.clear(h.COLOR_BUFFER_BIT),r=r&&h.getError()===h.NO_ERROR),r){h.bindFramebuffer(h.FRAMEBUFFER,null);const p=h.RGBA,m=h.UNSIGNED_BYTE,L=new Uint8Array(4);h.readPixels(0,0,1,1,p,m,L),r=r&&h.getError()===h.NO_ERROR}for(h.deleteTexture(m),h.deleteFramebuffer(L),h.bindFramebuffer(h.FRAMEBUFFER,null);!r&&h.getError()!==h.NO_ERROR;);return r}_getWebGLTextureType(p){if(1===this._webGLVersion){switch(p){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(p){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(p){let h=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=h?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(p){case 0:r=this._gl.ALPHA;break;case 1:r=this._gl.LUMINANCE;break;case 2:r=this._gl.LUMINANCE_ALPHA;break;case 6:r=this._gl.RED;break;case 7:r=this._gl.RG;break;case 4:r=h?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:r=h?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(p){case 8:r=this._gl.RED_INTEGER;break;case 9:r=this._gl.RG_INTEGER;break;case 10:r=this._gl.RGB_INTEGER;break;case 11:r=this._gl.RGBA_INTEGER}return r}_getRGBABufferInternalSizedFormat(p,h){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==h)switch(h){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return r?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(p){case 3:switch(h){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(h){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return r?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(h){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(h){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(h){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(h){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(h){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(h){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(h){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(p,h,r,m){let L=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],z=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];const C=L?4:3,v=L?this._gl.RGBA:this._gl.RGB,O=new Uint8Array(m*r*C);return z&&this.flushFramebuffer(),this._gl.readPixels(p,h,r,m,v,this._gl.UNSIGNED_BYTE,O),Promise.resolve(O)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const p=P.c._CreateCanvas(1,1),h=p.getContext("webgl")||p.getContext("experimental-webgl");this._IsSupported=null!=h&&!!window.WebGLRenderingContext}catch(p){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const p=P.c._CreateCanvas(1,1),h=p.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||p.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!h}catch(p){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}E._TempClearColorUint32=new Uint32Array(4),E._TempClearColorInt32=new Int32Array(4),E.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],E._ConcatenateShader=H.f,E._IsSupported=null,E._HasMajorPerformanceCaveat=null},2469:(p,h,r)=>{function m(p){return void 0===p.getPipelineContext}r.d(h,{b:()=>m})},2471:(p,h,r)=>{r.d(h,{c:()=>L});var m=r(1414);class L extends m.e{constructor(p){super(),this._buffer=p}get underlyingResource(){return this._buffer}}}}]);